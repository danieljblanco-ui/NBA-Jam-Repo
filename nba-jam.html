<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA JAM - ARCADE</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;font-family:'Arial Black',Arial,sans-serif}
canvas{image-rendering:pixelated;cursor:none}
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
// ============================================================
//  NBA JAM — FULL ARCADE CLONE (v2 — Big Heads Edition)
// ============================================================
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
const W=960,H=640;
canvas.width=W;canvas.height=H;
function resize(){const s=Math.min(window.innerWidth/W,window.innerHeight/H);canvas.style.width=(W*s)+'px';canvas.style.height=(H*s)+'px'}
resize();window.addEventListener('resize',resize);

// --- Input ---
const keys={};
window.addEventListener('keydown',e=>{keys[e.code]=true;e.preventDefault()});
window.addEventListener('keyup',e=>{
  keys[e.code]=false;
  if((e.code==='Space'||e.code==='KeyZ')&&scene==='gameplay'){
    const ctrl=getControlledPlayer&&getControlledPlayer();
    if(ctrl&&ctrl.shotMeter.active&&!ctrl.shotMeter.locked){
      ctrl.shotMeter.locked=true;
    }
    // Lock contest meter on keyup too
    if(ctrl&&ctrl.contestMeter.active&&!ctrl.contestMeter.locked){
      ctrl.contestMeter.locked=true;
    }
  }
});

// --- Audio ---
let audioCtx;
function ensureAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)()}
function playTone(freq,dur,type='square',vol=0.12){
  ensureAudio();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type=type;o.frequency.value=freq;
  g.gain.setValueAtTime(vol,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
  o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+dur);
}
function sfxShoot(){playTone(440,0.15,'triangle',0.18)}
function sfxDunk(){playTone(110,0.5,'sawtooth',0.25);setTimeout(()=>playTone(70,0.4,'square',0.2),50)}
function sfxSwish(){playTone(800,0.08,'sine',0.15);setTimeout(()=>playTone(1200,0.1,'sine',0.12),80)}
function sfxBuzzer(){playTone(180,1,'sawtooth',0.3)}
function sfxSteal(){playTone(300,0.1,'triangle',0.2)}
function sfxShove(){playTone(140,0.25,'sawtooth',0.2)}
function sfxSelect(){playTone(500,0.1,'square',0.15);setTimeout(()=>playTone(700,0.15,'square',0.15),100)}
function sfxFire(){for(let i=0;i<5;i++)setTimeout(()=>playTone(300+i*100,0.15,'sawtooth',0.18),i*60)}
function sfxBlock(){playTone(90,0.4,'sawtooth',0.3);setTimeout(()=>playTone(60,0.3,'square',0.25),40)}

// --- Per-Player Appearance Data ---
// Each player gets a custom head contour defined by bezier control points
// plus unique facial features for caricature recognition
// Head contour: crownW, crownH, templeW, cheekW, jawW, chinW, chinH
// Controls the bezier path that traces the head shape
// PLAYER_LOOKS v3 — Bold arcade style. headW/headH control ellipse shape,
// everything else is about BIG visible features you can read across the court.
const PLAYER_LOOKS={
  'M. JORDAN':{skin:'#6B4226',skinD:'#4D2E18',skinL:'#8B5A38',
    headW:1.0,headH:0.92,earSz:1.5,eyeSz:1.0,
    noseW:1.3,beard:'mustache',beardC:'#1A1A1A',
    hairC:'#1A1A1A',eyeC:'#2A1800',
    id:'jordan'}, // bald + big ears + thick stache
  'C. CLARK':{skin:'#F2C9A3',skinD:'#D4A882',skinL:'#FFE0C4',
    headW:0.88,headH:1.0,earSz:0.7,eyeSz:1.25,
    noseW:0.7,beard:'none',beardC:'',
    hairC:'#3A2210',eyeC:'#5A7A42',
    id:'clark'}, // ponytail + big eyes + glasses
  'L. JAMES':{skin:'#6B4226',skinD:'#4D2E18',skinL:'#8B5A38',
    headW:1.12,headH:0.88,earSz:1.0,eyeSz:0.95,
    noseW:1.4,beard:'full',beardC:'#1A1A1A',
    hairC:'#1A1A1A',eyeC:'#2A1800',
    id:'lebron'}, // headband + massive beard + wide jaw
  'C. PARKER':{skin:'#7B5233',skinD:'#5C3A20',skinL:'#9B7050',
    headW:0.9,headH:1.0,earSz:0.8,eyeSz:1.1,
    noseW:0.9,beard:'none',beardC:'',
    hairC:'#1A1A1A',eyeC:'#3A2200',
    id:'parker'}, // braids + elegant
  'S. CURRY':{skin:'#C49A6C',skinD:'#A07A50',skinL:'#E0BB90',
    headW:0.95,headH:0.95,earSz:0.9,eyeSz:1.15,
    noseW:0.85,beard:'goatee',beardC:'#1A1A1A',
    hairC:'#1A1A1A',eyeC:'#3A2200',
    id:'curry'}, // baby face + goatee + mouthguard
  'S. IONESCU':{skin:'#E8C9A0',skinD:'#C9A880',skinL:'#FFF0D8',
    headW:0.85,headH:1.02,earSz:0.7,eyeSz:1.3,
    noseW:0.65,beard:'none',beardC:'',
    hairC:'#2A1A08',eyeC:'#4A6A32',
    id:'ionescu'}, // ponytail + huge eyes
  'K. DURANT':{skin:'#5A3818',skinD:'#3D260E',skinL:'#7A5432',
    headW:0.82,headH:1.25,earSz:0.9,eyeSz:0.9,
    noseW:1.1,beard:'goatee',beardC:'#1A1A1A',
    hairC:'#1A1A1A',eyeC:'#2A1800',
    id:'durant'}, // TALL narrow head + slim goatee
  'D. TAURASI':{skin:'#E8C098',skinD:'#C9A078',skinL:'#FFE0C0',
    headW:0.95,headH:0.92,earSz:0.8,eyeSz:1.0,
    noseW:0.85,beard:'none',beardC:'',
    hairC:'#D4A040',eyeC:'#6A8A52',
    id:'taurasi'}, // blonde ponytail + fierce brows
  'G. ANTETOKOUNMPO':{skin:'#3D2610',skinD:'#2A1808',skinL:'#5A3C22',
    headW:0.85,headH:1.35,earSz:1.1,eyeSz:1.0,
    noseW:1.3,beard:'none',beardC:'',
    hairC:'#1A1A1A',eyeC:'#2A1800',
    id:'giannis'}, // SUPER tall head + headband
  "A'JA WILSON":{skin:'#5A3818',skinD:'#3D260E',skinL:'#7A5432',
    headW:0.92,headH:1.02,earSz:0.8,eyeSz:1.1,
    noseW:1.0,beard:'none',beardC:'',
    hairC:'#1A1A1A',eyeC:'#2A1800',
    id:'wilson'}, // braids + strong build
  'L. DONCIC':{skin:'#F0C8A0',skinD:'#D0A880',skinL:'#FFE8CC',
    headW:1.1,headH:0.88,earSz:0.95,eyeSz:1.0,
    noseW:1.0,beard:'none',beardC:'',
    hairC:'#5A4030',eyeC:'#6A8A6A',
    id:'doncic'}, // round chubby face + shaggy hair
  'A. OGWUMIKE':{skin:'#5A3818',skinD:'#3D260E',skinL:'#7A5432',
    headW:0.9,headH:1.0,earSz:0.75,eyeSz:1.15,
    noseW:1.0,beard:'none',beardC:'',
    hairC:'#1A1A1A',eyeC:'#2A1800',
    id:'ogwumike'}, // braids + beads
  'J. TATUM':{skin:'#7B5233',skinD:'#5C3A20',skinL:'#9B7050',
    headW:1.0,headH:0.95,earSz:0.95,eyeSz:1.0,
    noseW:1.1,beard:'goatee',beardC:'#1A1A1A',
    hairC:'#1A1A1A',eyeC:'#2A1800',
    id:'tatum'}, // flat-top fade + goatee
  'B. STEWART':{skin:'#6B4226',skinD:'#4D2E18',skinL:'#8B5A38',
    headW:0.9,headH:1.0,earSz:0.8,eyeSz:1.1,
    noseW:1.0,beard:'none',beardC:'',
    hairC:'#1A1A1A',eyeC:'#3A2200',
    id:'stewart'}, // short hair + headband
  'J. BUTLER':{skin:'#5A3818',skinD:'#3D260E',skinL:'#7A5432',
    headW:1.0,headH:1.0,earSz:0.9,eyeSz:0.95,
    noseW:1.2,beard:'full',beardC:'#1A1A1A',
    hairC:'#1A1A1A',eyeC:'#2A1800',
    id:'butler'}, // WILD emo hair + beard + headband
  'K. PLUM':{skin:'#F5D0A8',skinD:'#D5B088',skinL:'#FFF0D0',
    headW:0.85,headH:0.95,earSz:0.7,eyeSz:1.25,
    noseW:0.65,beard:'none',beardC:'',
    hairC:'#C89040',eyeC:'#5A7A42',
    id:'plum'}, // blonde ponytail + big smile
};

// --- Teams: NBA + WNBA Mix ---
const TEAMS=[
  {name:'CHICAGO',abbr:'CHI',color1:'#CE1141',color2:'#000000',
    players:[
      {name:'M. JORDAN',spd:9,threePt:8,dunk:10,def:7,hair:'bald',num:23,ht:1.0},
      {name:'C. CLARK',spd:9,threePt:9,dunk:5,def:6,hair:'ponytail',num:22,ht:0.85}
    ]},
  {name:'LOS ANGELES',abbr:'LAL',color1:'#552583',color2:'#FDB927',
    players:[
      {name:'L. JAMES',spd:8,threePt:7,dunk:10,def:8,hair:'headband',num:6,ht:1.05},
      {name:'C. PARKER',spd:8,threePt:8,dunk:6,def:7,hair:'ponytail',num:3,ht:0.88}
    ]},
  {name:'GOLDEN STATE',abbr:'GSW',color1:'#006BB6',color2:'#FDB927',
    players:[
      {name:'S. CURRY',spd:9,threePt:10,dunk:5,def:5,hair:'short',num:30,ht:0.9},
      {name:'S. IONESCU',spd:8,threePt:9,dunk:4,def:6,hair:'ponytail',num:11,ht:0.85}
    ]},
  {name:'PHOENIX',abbr:'PHX',color1:'#E56020',color2:'#1D1160',
    players:[
      {name:'K. DURANT',spd:8,threePt:9,dunk:9,def:6,hair:'short',num:35,ht:1.08},
      {name:'D. TAURASI',spd:7,threePt:10,dunk:3,def:6,hair:'ponytail',num:3,ht:0.87}
    ]},
  {name:'MILWAUKEE',abbr:'MIL',color1:'#00471B',color2:'#EEE1C6',
    players:[
      {name:'G. ANTETOKOUNMPO',spd:9,threePt:6,dunk:10,def:9,hair:'short',num:34,ht:1.1},
      {name:"A'JA WILSON",spd:8,threePt:7,dunk:8,def:9,hair:'ponytail',num:22,ht:0.95}
    ]},
  {name:'DALLAS',abbr:'DAL',color1:'#00538C',color2:'#B8C4CA',
    players:[
      {name:'L. DONCIC',spd:8,threePt:9,dunk:7,def:5,hair:'short',num:77,ht:1.0},
      {name:'A. OGWUMIKE',spd:7,threePt:7,dunk:6,def:8,hair:'braids',num:30,ht:0.9}
    ]},
  {name:'BOSTON',abbr:'BOS',color1:'#007A33',color2:'#BA9653',
    players:[
      {name:'J. TATUM',spd:8,threePt:8,dunk:9,def:7,hair:'short',num:0,ht:1.02},
      {name:'B. STEWART',spd:7,threePt:8,dunk:7,def:9,hair:'ponytail',num:30,ht:0.95}
    ]},
  {name:'MIAMI',abbr:'MIA',color1:'#98002E',color2:'#F9A01B',
    players:[
      {name:'J. BUTLER',spd:8,threePt:6,dunk:9,def:9,hair:'headband',num:22,ht:1.0},
      {name:'K. PLUM',spd:9,threePt:10,dunk:3,def:5,hair:'ponytail',num:10,ht:0.84}
    ]},
];

// --- Game State ---
let scene='title';
let selectedTeamP1=0,selectedTeamP2=1;
let cursorTeam=0;
let quarter=1,quarterTime=60*60;
const QUARTER_LENGTH=60*60;
let scoreP1=0,scoreP2=0;
let titleTimer=0,halftimeTimer=0,gameoverTimer=0;
let selectPhase=0,selectTimer=0;

// Possession management - prevents AI dunk loops
let possessionLocked=false; // true during dead ball / inbound
let inboundTimer=0;
let lastScoringTeamIsP1=null;
let shotClockTimer=0;
const SHOT_CLOCK=24*60; // 24 seconds

// --- Court (logical coordinates — flat space, projected to perspective) ---
const COURT={x:80,y:150,w:1600,h:400,
  hoopLeftX:140,hoopRightX:1600,hoopY:350,
  threeLineR:190,centerX:840,centerY:350};

// --- Camera ---
const CAMERA={x:0,targetX:0,smoothness:0.08};
function updateCamera(){
  let focusX=COURT.centerX;
  if(ball.owner){focusX=ball.owner.x}
  else if(ball.loose||ball.shotInFlight){focusX=ball.x}
  CAMERA.targetX=focusX-W/2;
  CAMERA.targetX=clamp(CAMERA.targetX,0,COURT.x+COURT.w-W+80);
  CAMERA.x+=(CAMERA.targetX-CAMERA.x)*CAMERA.smoothness;
}

// --- Pseudo-3D Perspective Projection ---
// Maps flat (x,y) court coords to screen coords with perspective
// Court bottom (y=550) is close/wide, court top (y=150) is far/narrow
const PERSP={
  vanishY:40,   // vanishing point Y (above screen)
  vanishX:480,  // vanishing point X (center)
  nearScale:1.15,  // scale at bottom of court
  farScale:0.55, // scale at top of court
  courtTop:150,
  courtBot:550,
};

function perspProject(x,y){
  const t=clamp((y-PERSP.courtTop)/(PERSP.courtBot-PERSP.courtTop),0,1);
  const scale=lerp(PERSP.farScale,PERSP.nearScale,t);
  const screenXLocal=x-CAMERA.x;
  const screenX=W/2+(screenXLocal-W/2)*scale;
  const screenY=lerp(PERSP.vanishY+110,PERSP.courtBot,t);
  return{x:screenX,y:screenY,scale};
}

function perspScale(y){
  const t=clamp((y-PERSP.courtTop)/(PERSP.courtBot-PERSP.courtTop),0,1);
  return lerp(PERSP.farScale,PERSP.nearScale,t);
}

// --- Entities ---
let players=[];
let ball={x:480,y:350,z:0,vx:0,vy:0,vz:0,owner:null,loose:false,
  shotInFlight:false,shotTarget:{x:0,y:0},shotArc:0,shotTime:0,shotMaxTime:0,
  shotStartX:0,shotStartY:0,shotStartZ:0,shooter:null,isThree:false,isMiss:false,
  passTarget:null};
let particles=[];
let shakeTimer=0,shakeMag=0;

// --- Announcer ---
let announcerText='',announcerTimer=0;
function announce(text,duration=120){announcerText=text;announcerTimer=duration}

// --- Utility ---
function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y)}
function lerp(a,b,t){return a+(b-a)*t}
function clamp(v,mn,mx){return Math.max(mn,Math.min(mx,v))}
function rnd(a,b){return a+Math.random()*(b-a)}
function rndInt(a,b){return Math.floor(rnd(a,b+1))}
function pick(arr){return arr[rndInt(0,arr.length-1)]}

// ============================================================
//  ANIMATION ENGINE — Multi-frame keyframed phase system
// ============================================================
function easeInOutQuad(t){return t<0.5?2*t*t:-1+(4-2*t)*t}
function easeOutBack(t){const c=1.7;return 1+c*Math.pow(t-1,3)+c*Math.pow(t-1,2)}

function interpKF(keyframes,frame){
  if(frame<=keyframes[0].f)return{...keyframes[0]};
  if(frame>=keyframes[keyframes.length-1].f)return{...keyframes[keyframes.length-1]};
  for(let i=0;i<keyframes.length-1;i++){
    const k0=keyframes[i],k1=keyframes[i+1];
    if(k0.f<=frame&&frame<=k1.f){
      const t=easeInOutQuad((frame-k0.f)/(k1.f-k0.f));
      const r={f:frame};
      for(const key of Object.keys(k0)){if(key!=='f')r[key]=lerp(k0[key],k1[key],t)}
      return r;
    }
  }
  return{...keyframes[keyframes.length-1]};
}

const ANIM={
  DUNK:{
    phases:['CROUCH','RISE','HANG','SLAM','LAND'],
    dur:[10,16,14,12,20],
    z:[{f:0,v:0},{f:8,v:-10},{f:10,v:20},{f:20,v:110},{f:30,v:130},{f:40,v:140},{f:52,v:40},{f:60,v:8},{f:72,v:0}],
    scY:[{f:0,v:1},{f:6,v:0.5},{f:10,v:0.5},{f:14,v:1.5},{f:26,v:1.55},{f:40,v:1.45},{f:52,v:0.55},{f:60,v:0.7},{f:72,v:1}],
    scX:[{f:0,v:1},{f:6,v:1.4},{f:10,v:1.4},{f:14,v:0.6},{f:26,v:0.55},{f:40,v:0.65},{f:52,v:1.45},{f:60,v:1.25},{f:72,v:1}],
    ballRelease:52,
    particles:[{f:10,type:'launch',n:18},{f:52,type:'slam',n:40},{f:60,type:'land',n:25}],
    shake:[{lo:52,hi:62,mag:20},{lo:62,hi:68,mag:8}]
  },
  DUNK_EXTENDED:{
    phases:['CROUCH','RISE','HANG','SLAM','LAND'],
    dur:[15,20,30,20,35],// 120 frames — Jordan flying through the air
    z:[{f:0,v:0},{f:10,v:-12},{f:15,v:25},{f:28,v:120},{f:35,v:145},{f:50,v:155},{f:65,v:150},{f:85,v:45},{f:100,v:10},{f:120,v:0}],
    scY:[{f:0,v:1},{f:8,v:0.45},{f:15,v:0.45},{f:22,v:1.55},{f:35,v:1.6},{f:65,v:1.55},{f:85,v:0.5},{f:100,v:0.65},{f:120,v:1}],
    scX:[{f:0,v:1},{f:8,v:1.45},{f:15,v:1.45},{f:22,v:0.55},{f:35,v:0.5},{f:65,v:0.55},{f:85,v:1.5},{f:100,v:1.3},{f:120,v:1}],
    ballRelease:85,// late slam after long hang
    particles:[{f:15,type:'launch',n:25},{f:45,type:'hang',n:15},{f:85,type:'slam',n:55},{f:100,type:'land',n:30}],
    shake:[{lo:85,hi:100,mag:25},{lo:100,hi:110,mag:12}]
  },
  JUMP_SHOT:{
    phases:['GATHER','RISE','HANG','RELEASE','LAND'],
    dur:[8,14,16,8,18],// total=64 frames — more hang time
    z:[{f:0,v:0},{f:6,v:-4},{f:8,v:10},{f:22,v:80},{f:38,v:90},{f:46,v:75},{f:64,v:0}],
    scY:[{f:0,v:1},{f:5,v:0.6},{f:8,v:0.6},{f:18,v:1.45},{f:38,v:1.5},{f:46,v:1.35},{f:56,v:0.65},{f:64,v:1}],
    scX:[{f:0,v:1},{f:5,v:1.3},{f:8,v:1.3},{f:18,v:0.65},{f:38,v:0.6},{f:46,v:0.7},{f:56,v:1.3},{f:64,v:1}],
    ballRelease:38,// frame when shot releases (apex of HANG)
    particles:[{f:8,type:'launch',n:8},{f:38,type:'release',n:12}],
    shake:[]
  },
  BLOCK:{
    phases:['LEAP','SWAT','LAND'],
    dur:[10,10,14],// total=34
    z:[{f:0,v:0},{f:5,v:-5},{f:10,v:100},{f:20,v:90},{f:34,v:0}],
    scY:[{f:0,v:0.7},{f:5,v:0.55},{f:10,v:1.55},{f:20,v:1.45},{f:26,v:0.6},{f:34,v:1}],
    scX:[{f:0,v:1.2},{f:5,v:1.35},{f:10,v:0.6},{f:20,v:0.65},{f:26,v:1.4},{f:34,v:1}],
    ballRelease:-1,
    particles:[{f:12,type:'swat',n:20}],
    shake:[{lo:10,hi:16,mag:8}]
  },
  SHOVE:{
    phases:['WINDUP','STRIKE','FOLLOW','RECOVER'],
    dur:[6,6,10,10],// total=32
    z:[{f:0,v:0},{f:6,v:0},{f:12,v:8},{f:22,v:3},{f:32,v:0}],
    scY:[{f:0,v:1},{f:6,v:0.7},{f:12,v:1.2},{f:22,v:1.05},{f:32,v:1}],
    scX:[{f:0,v:1},{f:6,v:1.3},{f:12,v:1.45},{f:22,v:1.1},{f:32,v:1}],
    ballRelease:-1,
    particles:[{f:12,type:'impact',n:15}],
    shake:[{lo:11,hi:16,mag:10}]
  },
  STEAL:{
    phases:['CROUCH','REACH','SWIPE','RECOVER'],
    dur:[6,8,10,12],// total=36 — very visible reaching lunge
    z:[{f:0,v:0},{f:6,v:0},{f:14,v:3},{f:24,v:1},{f:36,v:0}],
    scY:[{f:0,v:1},{f:4,v:0.65},{f:6,v:0.6},{f:14,v:0.75},{f:24,v:0.85},{f:36,v:1}],
    scX:[{f:0,v:1},{f:4,v:1.2},{f:6,v:1.35},{f:14,v:1.4},{f:24,v:1.15},{f:36,v:1}],
    ballRelease:-1,
    particles:[{f:10,type:'swipe',n:10}],
    shake:[]
  }
};

function startAnim(p,type){
  const def=ANIM[type];if(!def)return;
  p.anim={type,def,phase:def.phases[0],pi:0,fip:0,fc:0,
    total:def.dur.reduce((a,b)=>a+b,0),
    startX:p.x,startY:p.y,released:false};
}

function updateAnim(p){
  const a=p.anim;if(!a||!a.type)return false;
  a.fc++;a.fip++;
  const def=a.def;
  // Phase advance
  if(a.fip>=def.dur[a.pi]){
    a.pi++;a.fip=0;
    if(a.pi>=def.phases.length){endAnim(p);return false}
    a.phase=def.phases[a.pi];
  }
  // Z from curve
  const zv=interpKF(def.z,a.fc);
  p.z=Math.max(0,zv.v);p.vz=0;
  // Body scale
  const sy=interpKF(def.scY,a.fc);
  const sx=interpKF(def.scX,a.fc);
  p.animScY=sy.v;p.animScX=sx.v;
  // Dunk: move toward hoop (regular and extended)
  if(a.type==='DUNK'||a.type==='DUNK_EXTENDED'){
    const t=a.fc/a.total;
    const moveT=Math.min(t*(a.type==='DUNK_EXTENDED'?1.1:1.3),1);
    p.x=lerp(a.startX,p.dunkTarget.x,moveT);
    p.y=lerp(a.startY,p.dunkTarget.y,moveT);
    if(a.fc>=def.ballRelease&&!a.released&&p.hasBall){a.released=true;performDunk(p)}
  }
  // Jump shot: release ball
  if(a.type==='JUMP_SHOT'){
    if(a.fc>=def.ballRelease&&!a.released&&p.hasBall){a.released=true;releaseShot(p)}
  }
  // Shove: check hit on STRIKE frame
  if(a.type==='SHOVE'&&a.phase==='STRIKE'&&a.fip===1){
    shoveHitCheck(p);
  }
  // Steal: check hit during SWIPE phase
  if(a.type==='STEAL'&&a.phase==='SWIPE'&&a.fip===1){
    stealHitCheck(p);
  }
  // Particles
  for(const pe of def.particles){
    if(a.fc===pe.f)spawnAnimParticles(p,pe);
  }
  // Screen shake
  for(const sh of def.shake){
    if(a.fc>=sh.lo&&a.fc<=sh.hi){shakeTimer=Math.max(shakeTimer,3);shakeMag=Math.max(shakeMag,sh.mag)}
  }
  // Backward compat flags
  p.dunking=(a.type==='DUNK'||a.type==='DUNK_EXTENDED');
  p.shooting=(a.type==='JUMP_SHOT');
  p.shoving=(a.type==='SHOVE');
  p.blocking=(a.type==='BLOCK');
  p.stealing=(a.type==='STEAL');
  return true;// signal: skip normal physics
}

function endAnim(p){
  p.anim=null;p.dunking=false;p.shooting=false;p.shoving=false;p.blocking=false;p.stealing=false;
  p.z=Math.max(p.z,0);p.vz=0;p.animScY=1;p.animScX=1;
}

function shoveHitCheck(p){
  for(const other of players){
    if(other.isP1===p.isP1)continue;
    if(dist(p,other)<50){
      other.stumble=45;
      other.vx=(other.x-p.x)*0.35;other.vy=(other.y-p.y)*0.35;
      if(other.hasBall){
        other.hasBall=false;ball.owner=null;ball.loose=true;
        ball.vx=other.vx*2+rnd(-2,2);ball.vy=other.vy*2+rnd(-2,2);ball.vz=rnd(2,5);
        ball.x=other.x;ball.y=other.y;ball.z=15;
        announce(pick(['REJECTED!','GET THAT OUTTA HERE!','NOT IN MY HOUSE!']),60);
      }
      spawnHitParticles(other.x,other.y);
      break;
    }
  }
}

function spawnAnimParticles(p,pe){
  const px=p.x,py=p.y-p.z-20;
  if(pe.type==='launch'){
    // Huge dust cloud on takeoff
    for(let i=0;i<pe.n;i++)particles.push({x:px+rnd(-20,20),y:p.y+12,vx:rnd(-6,6),vy:rnd(-2,4),life:28,maxLife:28,color:`hsl(${rnd(30,60)},100%,${rnd(50,70)}%)`,size:rnd(6,14)});
  }else if(pe.type==='slam'){
    // Massive explosion on dunk
    const hx=p.dunkTarget?p.dunkTarget.x:px,hy=p.dunkTarget?p.dunkTarget.y:py;
    for(let i=0;i<pe.n;i++)particles.push({x:hx+rnd(-40,40),y:hy+rnd(-25,25),vx:rnd(-12,12),vy:rnd(-8,4),life:rnd(30,55),maxLife:55,color:`hsl(${rnd(0,50)},100%,${rnd(45,65)}%)`,size:rnd(8,22)});
    // Add white flash particles
    for(let i=0;i<8;i++)particles.push({x:hx+rnd(-15,15),y:hy+rnd(-10,10),vx:rnd(-3,3),vy:rnd(-3,3),life:10,maxLife:10,color:'#FFFFFF',size:rnd(15,30)});
  }else if(pe.type==='land'){
    // Big landing dust
    for(let i=0;i<pe.n;i++)particles.push({x:px+rnd(-30,30),y:p.y+15,vx:rnd(-6,6),vy:rnd(-2,2),life:24,maxLife:24,color:'rgba(255,255,255,0.7)',size:rnd(5,12)});
  }else if(pe.type==='release'){
    // Shot release sparkle
    for(let i=0;i<pe.n;i++)particles.push({x:px+p.facing*15,y:py-12,vx:p.facing*rnd(2,5),vy:rnd(-3,1),life:16,maxLife:16,color:`hsl(${rnd(40,60)},100%,75%)`,size:rnd(3,7)});
  }else if(pe.type==='swat'){
    // Block explosion
    for(let i=0;i<pe.n;i++)particles.push({x:px+rnd(-15,15),y:py+rnd(-15,15),vx:rnd(-8,8),vy:rnd(-6,4),life:22,maxLife:22,color:`hsl(${rnd(0,20)},100%,50%)`,size:rnd(6,14)});
  }else if(pe.type==='impact'){
    spawnHitParticles(px,py);
  }else if(pe.type==='swipe'){
    // Steal swipe — horizontal streak particles
    for(let i=0;i<pe.n;i++)particles.push({x:px+p.facing*rnd(10,30),y:py+rnd(-5,15),vx:p.facing*rnd(4,10),vy:rnd(-2,2),life:14,maxLife:14,color:`hsl(${rnd(180,220)},80%,65%)`,size:rnd(4,9)});
  }else if(pe.type==='hang'){
    // Extended dunk hang fire trail
    for(let i=0;i<pe.n;i++)particles.push({x:px+rnd(-15,15),y:py+rnd(-5,10),vx:rnd(-3,3),vy:rnd(1,4),life:20,maxLife:20,color:`hsl(${rnd(15,45)},100%,${rnd(50,70)}%)`,size:rnd(5,12)});
  }
}

// --- Player ---
function createPlayer(teamIdx,playerIdx,team,isP1,slot){
  const p=team.players[playerIdx];
  const side=isP1?-1:1;
  return{
    teamIdx,playerIdx,team,stats:p,isP1,slot,
    x:COURT.centerX+side*(200+slot*120),
    y:COURT.centerY+(slot===0?-50:50),
    vx:0,vy:0,z:0,vz:0,
    facing:isP1?1:-1,
    hasBall:false,
    turbo:100,turboActive:false,
    onFire:false,fireStreak:0,
    shooting:false,shootTimer:0,
    dunking:false,dunkTimer:0,dunkTarget:{x:0,y:0},dunkStartX:0,dunkStartY:0,
    shoving:false,shoveTimer:0,shoveCooldown:0,
    stealing:false,stealCooldown:0,
    stumble:0,
    controlled:false,
    aiTimer:0,aiState:'idle',aiDecisionTimer:0,aiTargetX:0,aiTargetY:0,
    anim:null,animScY:1,animScX:1,blocking:false,
    animFrame:0,animTimer:0,
    flashTimer:0,
    width:36,height:48,
    speed:2.2+p.spd*0.28,
    // for smooth sprite animation
    runCycle:0,
    // Motion trail ring buffer (last 5 positions)
    trail:[],trailTimer:0,
    // Shot meter
    shotMeter:{active:false,fill:0,dir:1,speed:2.8,locked:false},
    // Defender contest meter
    contestMeter:{active:false,fill:0,dir:1,speed:3.5,locked:false,target:null},
    // Double-tap dunk detection
    lastSpaceTime:0,
  };
}

function initGame(){
  players=[];
  const t1=TEAMS[selectedTeamP1],t2=TEAMS[selectedTeamP2];
  players.push(createPlayer(selectedTeamP1,0,t1,true,0));
  players.push(createPlayer(selectedTeamP1,1,t1,true,1));
  players.push(createPlayer(selectedTeamP2,0,t2,false,0));
  players.push(createPlayer(selectedTeamP2,1,t2,false,1));
  players[0].controlled=true;
  players[0].hasBall=true;
  ball.owner=players[0];
  ball.loose=false;ball.shotInFlight=false;
  scoreP1=0;scoreP2=0;
  quarter=1;quarterTime=QUARTER_LENGTH;
  shotClockTimer=SHOT_CLOCK;
  particles=[];
  possessionLocked=false;
  announce('BOOMSHAKALAKA!',150);
}

// --- Helpers ---
function getTeamWithBall(){if(ball.owner)return ball.owner.isP1?'p1':'p2';return null}
function getControlledPlayer(){return players.find(p=>p.controlled&&p.isP1)}
function switchControlledPlayer(){
  const curr=getControlledPlayer();
  const tm=players.find(p=>p.isP1&&p!==curr);
  if(curr)curr.controlled=false;
  if(tm)tm.controlled=true;
}
function getTargetHoop(p){return p.isP1?{x:COURT.hoopRightX,y:COURT.hoopY}:{x:COURT.hoopLeftX,y:COURT.hoopY}}
function isInDunkRange(p){return dist(p,getTargetHoop(p))<110}
function isThreePoint(p){return dist(p,getTargetHoop(p))>COURT.threeLineR}

// --- Shooting ---
function attemptShot(p){
  if(!p.hasBall||p.shooting||p.dunking||p.z>0||possessionLocked||p.anim)return;
  startAnim(p,'JUMP_SHOT');
  sfxShoot();
  const hoop=getTargetHoop(p);
  const d=dist(p,hoop);
  const three=isThreePoint(p);
  // Meter speed increases with distance — harder to time long shots
  const baseSpeed=2.0+rnd(0,0.8);
  const distBonus=three?1.2:d>250?0.6:0;
  p.shotMeter.active=true;p.shotMeter.fill=0;p.shotMeter.dir=1;
  p.shotMeter.speed=baseSpeed+distBonus;p.shotMeter.locked=false;
  p.shotMeter.sweetSpotSize=three?12:18; // narrower sweet spot for 3s
  p.shotMeter.isThree=three;
  p.shotMeter.shotDist=d;
  // Alert nearby defenders — they can contest!
  for(const def of players){
    if(def.isP1===p.isP1)continue;
    const dd=dist(def,p);
    if(dd<80&&!def.anim&&def.z===0){
      def.contestMeter.target=p; // track who they're contesting
    }
  }
  // AI auto-locks meter at skill-weighted position
  if(!p.controlled||!p.isP1){
    const skill=((p.stats.threePt||5)+(p.stats.dunk||5))/2;
    const variance=35-skill*2.5;
    p.shotMeter.fill=50+rnd(-variance,variance);
    p.shotMeter.locked=true;
  }
}

function attemptDunk(p){
  if(!p.hasBall||p.shooting||p.dunking||p.z>0||possessionLocked||p.anim)return;
  const hoop=getTargetHoop(p);
  const d=dist(p,hoop);
  if(d<160&&p.stats.dunk>=3){
    // Extended dunk with long hang time
    p.dunkTarget={x:hoop.x,y:hoop.y};
    startAnim(p,'DUNK_EXTENDED');
    sfxDunk();
    announce(pick(['BOOMSHAKALAKA!','MONSTER JAM!','THROWS IT DOWN!','SLAM DUNK!','KABOOM!','OH MY!','SPECTACULAR!']),90);
  }else if(d<200){
    // Too far for dunk — do regular shot instead
    attemptShot(p);
  }
}

// --- Contest system ---
function attemptContest(def){
  // Defender tries to contest a nearby shooter
  if(def.contestMeter.active||def.anim)return;
  const shooter=def.contestMeter.target;
  if(!shooter||!shooter.anim||shooter.anim.type!=='JUMP_SHOT')return;
  if(dist(def,shooter)>90)return;
  // Start the block/contest meter
  def.contestMeter.active=true;
  def.contestMeter.fill=0;def.contestMeter.dir=1;
  def.contestMeter.speed=3.0+rnd(0,1.5);
  def.contestMeter.locked=false;
  // Jump into block animation
  startAnim(def,'BLOCK');
  playTone(280,0.06,'square',0.08);
}

function releaseShot(p){
  if(!p.hasBall)return;
  const hoop=getTargetHoop(p);
  const d=dist(p,hoop);
  const three=isThreePoint(p);
  let acc=three?p.stats.threePt:(p.stats.threePt+p.stats.dunk)/2;
  if(p.onFire)acc+=3;
  if(p.turboActive)acc+=0.5;
  acc-=Math.max(0,(d-200)*0.01);

  // Shot meter modifier — sweet spot is center, size varies by distance
  const meterVal=p.shotMeter.fill;
  const sweetSize=p.shotMeter.sweetSpotSize||15;
  const distC=Math.abs(meterVal-50);
  if(distC<=sweetSize){
    // In the green zone — bonus scales with precision
    acc+=3.0-distC*(2.5/sweetSize);
  }else{
    // Outside green zone — penalty increases sharply
    acc-=(distC-sweetSize)*0.08;
  }

  // Defender contest modifier
  let contested=false;
  let blocked=false;
  let contestLabel='';
  for(const def of players){
    if(def.isP1===p.isP1)continue;
    if(def.contestMeter.target!==p)continue;
    const dd=dist(def,p);
    if(dd>100){def.contestMeter.active=false;def.contestMeter.target=null;continue}
    if(def.contestMeter.active){
      const cVal=def.contestMeter.fill;
      const cDistC=Math.abs(cVal-50);
      const defSkill=def.stats.def||5;
      if(cDistC<=12&&dd<50){
        // Perfect contest + close = BLOCKED!
        blocked=true;
        contestLabel='BLOCKED!';
        announce(pick(['REJECTED!','GET THAT OUTTA HERE!','NO NO NO!','SWATTED!','DENIED!']),90);
        shakeTimer=12;shakeMag=15;
      }else if(cDistC<=20&&dd<70){
        // Good contest — heavy penalty
        acc-=3.5;contested=true;
        contestLabel='CONTESTED!';
      }else if(dd<90){
        // Presence alone affects shot
        acc-=1.5;contested=true;
        contestLabel='HAND IN FACE!';
      }
    }else if(dd<60){
      // Defender didn't use meter but is nearby — light contest
      acc-=1.0;contested=true;
    }
    def.contestMeter.active=false;def.contestMeter.target=null;
  }

  p.shotMeter.active=false;

  if(blocked){
    // Ball gets swatted — goes loose with force
    p.hasBall=false;ball.owner=null;
    ball.x=p.x;ball.y=p.y;ball.z=p.z+25;
    ball.shotInFlight=false;ball.loose=true;
    ball.vx=rnd(-6,6);ball.vy=rnd(-4,4);ball.vz=rnd(3,6);
    sfxBlock();
    for(let i=0;i<20;i++)particles.push({x:p.x+rnd(-10,10),y:p.y-p.z+rnd(-10,10),
      vx:rnd(-6,6),vy:rnd(-5,3),life:18,maxLife:18,color:'#FF4444',size:rnd(5,12)});
    return; // no shot released
  }

  if(contested&&contestLabel){announce(contestLabel,50)}

  const miss=rnd(0,10)>clamp(acc,1,10);
  const tx=hoop.x+(miss?rnd(-45,45):rnd(-8,8));
  const ty=hoop.y+(miss?rnd(-35,35):rnd(-5,5));

  p.hasBall=false;ball.owner=null;
  ball.x=p.x;ball.y=p.y;ball.z=p.z+30;
  ball.shotInFlight=true;
  ball.shotTarget={x:tx,y:ty};
  ball.shotTime=0;ball.shotMaxTime=Math.max(35,d/7.5);
  ball.shotStartX=ball.x;ball.shotStartY=ball.y;ball.shotStartZ=ball.z;
  ball.shooter=p;ball.isThree=three;ball.isMiss=miss;
  p.shooting=false;
}

function performDunk(p){
  const hoop=getTargetHoop(p);
  p.hasBall=false;ball.owner=null;
  ball.x=hoop.x;ball.y=hoop.y;ball.z=50;
  ball.vx=0;ball.vy=0;ball.vz=-2;
  ball.shotInFlight=false;ball.loose=true;

  if(p.isP1)scoreP1+=2;else scoreP2+=2;
  p.fireStreak++;
  if(p.fireStreak>=3&&!p.onFire){p.onFire=true;announce("HE'S ON FIRE!",120);sfxFire()}
  // Reset opposing fire
  players.filter(o=>o.isP1!==p.isP1).forEach(o=>{o.fireStreak=0;o.onFire=false});
  shakeTimer=18;shakeMag=10;
  spawnDunkParticles(hoop.x,hoop.y);
  sfxDunk();
  // --- POSSESSION FIX: lock possession, schedule inbound to OTHER team ---
  lastScoringTeamIsP1=p.isP1;
  lockPossessionAndInbound(!p.isP1);
}

// --- Possession management ---
function lockPossessionAndInbound(toP1){
  possessionLocked=true;
  inboundTimer=90; // 1.5 seconds before inbound
  // Nobody can pick up the ball during inbound
  ball.inboundTo=toP1;
}

function doInbound(toP1){
  possessionLocked=false;
  const receiver=players.find(p=>p.isP1===toP1&&p.slot===0)||players.find(p=>p.isP1===toP1);
  if(receiver){
    receiver.hasBall=true;ball.owner=receiver;
    ball.loose=false;ball.shotInFlight=false;
    ball.vx=0;ball.vy=0;ball.vz=0;ball.z=0;
  }
  resetPositions(toP1);
  shotClockTimer=SHOT_CLOCK;
}

function resetPositions(offIsP1){
  players.forEach(p=>{
    const off=p.isP1===offIsP1;
    if(off){
      p.x=offIsP1?COURT.centerX-80-p.slot*70:COURT.centerX+80+p.slot*70;
    }else{
      p.x=offIsP1?COURT.centerX+60+p.slot*70:COURT.centerX-60-p.slot*70;
    }
    p.y=COURT.centerY+(p.slot===0?-55:55);
    p.vx=0;p.vy=0;p.z=0;p.vz=0;
    p.dunking=false;p.shooting=false;p.stumble=0;
  });
}

// --- Ball Physics ---
function updateBall(){
  // Inbound timer
  if(possessionLocked){
    inboundTimer--;
    if(inboundTimer<=0){
      doInbound(ball.inboundTo);
    }
    // Ball bounces down near hoop area while waiting
    if(ball.loose){
      ball.x+=ball.vx;ball.y+=ball.vy;ball.z+=ball.vz;ball.vz-=0.4;
      if(ball.z<=0){ball.z=0;ball.vz=Math.abs(ball.vz)*0.4;ball.vx*=0.7;ball.vy*=0.7;if(Math.abs(ball.vz)<0.3)ball.vz=0}
    }
    return;
  }

  if(ball.owner){
    ball.x=ball.owner.x+ball.owner.facing*14;
    ball.y=ball.owner.y;
    ball.z=ball.owner.z+18;
    return;
  }
  if(ball.shotInFlight){
    ball.shotTime++;
    const t=ball.shotTime/ball.shotMaxTime;
    if(t>=1){
      ball.x=ball.shotTarget.x;ball.y=ball.shotTarget.y;
      ball.shotInFlight=false;
      if(!ball.isMiss){
        const pts=ball.isThree?3:2;
        if(ball.shooter.isP1)scoreP1+=pts;else scoreP2+=pts;
        ball.shooter.fireStreak++;
        if(ball.shooter.fireStreak>=3&&!ball.shooter.onFire){
          ball.shooter.onFire=true;announce("HE'S ON FIRE!",120);sfxFire();
        }
        players.filter(o=>o.isP1!==ball.shooter.isP1).forEach(o=>{o.fireStreak=0;o.onFire=false});
        sfxSwish();
        if(ball.isThree)announce("FROM DOWNTOWN!",90);
        else announce(pick(['NOTHING BUT NET!','HEATING UP!','MONEY!','COUNT IT!','SWISH!','TOO EASY!']),90);
        spawnScoreParticles(ball.x,ball.y);
        ball.z=40;ball.vz=-1;ball.vx=(ball.shooter.isP1?-1:1)*2;ball.vy=rnd(-1,1);
        ball.loose=true;
        lastScoringTeamIsP1=ball.shooter.isP1;
        lockPossessionAndInbound(!ball.shooter.isP1);
      }else{
        announce(pick(['BRICK!','NO GOOD!','OFF THE RIM!','CLANK!']),60);
        // Realistic rim deflection
        const hoopX=ball.shotTarget.x,hoopY=ball.shotTarget.y;
        const arriveX=ball.shotStartX,arriveY=ball.shotStartY;
        const hitAngle=Math.atan2(arriveY-hoopY,arriveX-hoopX);
        const deflectSpeed=rnd(1.5,3.5);
        ball.vx=Math.cos(hitAngle)*deflectSpeed+rnd(-0.5,0.5);
        ball.vy=Math.sin(hitAngle)*deflectSpeed*0.5+rnd(-0.3,0.3);
        ball.vz=rnd(2.5,5);ball.z=35;
        if(ball.shooter){
          const ss=ball.shooter.isP1?1:-1;
          if(ss>0&&arriveX>hoopX+10)ball.vx=-Math.abs(ball.vx)*0.8;
          if(ss<0&&arriveX<hoopX-10)ball.vx=Math.abs(ball.vx)*0.8;
        }
        ball.loose=true;
        if(ball.shooter){ball.shooter.fireStreak=0;ball.shooter.onFire=false}
      }
    }else{
      ball.x=lerp(ball.shotStartX,ball.shotTarget.x,t);
      ball.y=lerp(ball.shotStartY,ball.shotTarget.y,t);
      ball.z=lerp(ball.shotStartZ,40,t)+Math.sin(t*Math.PI)*(100+ball.shotMaxTime*1.5);
    }
    return;
  }
  // Loose ball
  if(ball.loose){
    ball.x+=ball.vx;ball.y+=ball.vy;ball.z+=ball.vz;ball.vz-=0.4;
    if(ball.z<=0){ball.z=0;ball.vz=Math.abs(ball.vz)*0.55;ball.vx*=0.8;ball.vy*=0.8;if(Math.abs(ball.vz)<0.5)ball.vz=0}
    // Wall bouncing
    if(ball.x<COURT.x+10){ball.x=COURT.x+10;ball.vx=Math.abs(ball.vx)*0.6}
    if(ball.x>COURT.x+COURT.w-10){ball.x=COURT.x+COURT.w-10;ball.vx=-Math.abs(ball.vx)*0.6}
    if(ball.y<COURT.y+10){ball.y=COURT.y+10;ball.vy=Math.abs(ball.vy)*0.6}
    if(ball.y>COURT.y+COURT.h-10){ball.y=COURT.y+COURT.h-10;ball.vy=-Math.abs(ball.vy)*0.6}
    // Pickup
    for(const p of players){
      if(p.stumble>0||p.dunking||p.shooting||p.anim)continue;
      if(dist(p,ball)<40&&ball.z<28){
        const wasPass=ball.passTarget===p;
        p.hasBall=true;ball.owner=p;ball.loose=false;ball.shotInFlight=false;
        ball.passTarget=null;
        shotClockTimer=SHOT_CLOCK;
        // Auto-switch control to ball carrier on P1 team
        if(p.isP1&&!p.controlled){
          const prev=players.find(pp=>pp.isP1&&pp.controlled);
          if(prev)prev.controlled=false;
          p.controlled=true;
        }
        if(wasPass){
          for(let i=0;i<10;i++){const a=Math.PI*2*i/10;
            particles.push({x:p.x,y:p.y,z:p.z+12,vx:Math.cos(a)*2.5,vy:Math.sin(a)*1.2,vz:rnd(1,3),
              life:22,maxLife:22,color:p.team.color2||'#FFD700',size:3});}
          playTone(500,0.06,'sine',0.12);
        }
        break;
      }
    }
  }
}

// --- Pass ---
let passTargetFlash=0;
function passBall(p){
  if(possessionLocked)return;
  const tm=players.find(pp=>pp.isP1===p.isP1&&pp!==p);
  if(!tm)return;
  p.hasBall=false;ball.owner=null;
  ball.x=p.x;ball.y=p.y;ball.z=p.z+18;
  ball.shotInFlight=false;ball.loose=true;
  ball.passTarget=tm;
  const d=dist(p,tm);const spd=9;
  ball.vx=(tm.x-p.x)/d*spd;ball.vy=(tm.y-p.y)/d*spd;ball.vz=2;
  playTone(350,0.08,'triangle',0.12);
  // Immediately switch control to the receiver so player can reposition them
  if(p.isP1&&p.controlled){
    p.controlled=false;
    tm.controlled=true;
  }
}

function drawPassIndicator(){
  const ctrl=getControlledPlayer();
  if(!ctrl||!ctrl.hasBall||possessionLocked)return;
  const tm=players.find(pp=>pp.isP1===ctrl.isP1&&pp!==ctrl);
  if(!tm)return;
  const p1=perspProject(ctrl.x,ctrl.y),p2=perspProject(tm.x,tm.y);
  const dx=p2.x-p1.x,dy=p2.y-p1.y,d=Math.hypot(dx,dy);if(d<5)return;
  const nx=dx/d,ny=dy/d;
  ctx.save();
  ctx.strokeStyle=`rgba(255,255,100,${0.35+Math.sin(Date.now()*0.008)*0.15})`;
  ctx.lineWidth=2;ctx.setLineDash([6,4]);
  ctx.beginPath();ctx.moveTo(p1.x+nx*20,p1.y+ny*20);ctx.lineTo(p2.x-nx*16,p2.y-ny*16);ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle=`rgba(255,255,100,${0.5+Math.sin(Date.now()*0.008)*0.2})`;
  ctx.beginPath();ctx.moveTo(p2.x-nx*12,p2.y-ny*12);
  ctx.lineTo(p2.x-nx*22-ny*6,p2.y-ny*22+nx*6);
  ctx.lineTo(p2.x-nx*22+ny*6,p2.y-ny*22-nx*6);
  ctx.closePath();ctx.fill();
  ctx.font='bold 11px Arial';ctx.fillStyle='rgba(255,255,100,0.7)';ctx.textAlign='center';
  ctx.fillText('[X]',p2.x,p2.y-22*p2.scale);
  ctx.restore();
}

function drawShotMeters(){
  for(const p of players){
    // Draw shooter's shot meter
    if(p.shotMeter.active){
      const pp=perspProject(p.x,p.y);
      const sc=pp.scale;
      const barW=50*sc, barH=6*sc;
      const bx=pp.x-barW/2, by=pp.y+28*sc;
      // Background
      ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(bx-1,by-1,barW+2,barH+2);
      // Sweet spot zone (variable size)
      const sweetSize=p.shotMeter.sweetSpotSize||15;
      const sweetPct=sweetSize/50; // convert to 0-1 range
      const gx=bx+barW*(0.5-sweetPct);
      ctx.fillStyle='rgba(0,200,0,0.35)';ctx.fillRect(gx,by,barW*sweetPct*2,barH);
      // Fill bar
      const fillW=barW*(p.shotMeter.fill/100);
      const distC=Math.abs(p.shotMeter.fill-50);
      ctx.fillStyle=distC<=sweetSize?'#00FF44':distC<=sweetSize+10?'#FFD700':'#FF3322';
      ctx.fillRect(bx,by,fillW,barH);
      // Cursor
      ctx.fillStyle='#FFF';ctx.fillRect(bx+fillW-1,by-2,3,barH+4);
      // Perfect label
      if(p.shotMeter.locked&&distC<=sweetSize){
        ctx.font=`bold ${Math.round(9*sc)}px Arial`;ctx.fillStyle='#00FF44';ctx.textAlign='center';
        ctx.fillText('PERFECT!',pp.x,by+barH+12*sc);
      }
      // "SHOT" label above bar
      ctx.font=`bold ${Math.round(7*sc)}px Arial`;ctx.fillStyle='rgba(255,255,255,0.7)';ctx.textAlign='center';
      ctx.fillText('SHOT',pp.x,by-3*sc);
    }
    // Draw defender's contest meter (red themed)
    if(p.contestMeter.active){
      const pp=perspProject(p.x,p.y);
      const sc=pp.scale;
      const barW=44*sc, barH=5*sc;
      const bx=pp.x-barW/2, by=pp.y+26*sc;
      // Background
      ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(bx-1,by-1,barW+2,barH+2);
      // Sweet spot zone (center 24%)
      const gx=bx+barW*0.38;
      ctx.fillStyle='rgba(255,60,0,0.35)';ctx.fillRect(gx,by,barW*0.24,barH);
      // Fill bar
      const fillW=barW*(p.contestMeter.fill/100);
      const cDistC=Math.abs(p.contestMeter.fill-50);
      ctx.fillStyle=cDistC<=12?'#FF2200':cDistC<=20?'#FF8800':'#884400';
      ctx.fillRect(bx,by,fillW,barH);
      // Cursor
      ctx.fillStyle='#FFF';ctx.fillRect(bx+fillW-1,by-2,3,barH+4);
      // Labels
      ctx.font=`bold ${Math.round(7*sc)}px Arial`;ctx.fillStyle='rgba(255,100,100,0.9)';ctx.textAlign='center';
      ctx.fillText('BLOCK',pp.x,by-3*sc);
      if(p.contestMeter.locked&&cDistC<=12){
        ctx.font=`bold ${Math.round(9*sc)}px Arial`;ctx.fillStyle='#FF2200';
        ctx.fillText('REJECT!',pp.x,by+barH+12*sc);
      }
    }
  }
}

// --- Shove ---
function doShove(p){
  if(p.shoveCooldown>0||possessionLocked||p.anim)return;
  p.shoveCooldown=35;
  startAnim(p,'SHOVE');
  sfxShove();
}

// --- Steal ---
function doSteal(p){
  if(p.stealCooldown>0||possessionLocked||p.anim)return;
  p.stealCooldown=30;p.stealing=true;
  startAnim(p,'STEAL');
}
function stealHitCheck(p){
  for(const other of players){
    if(other.isP1===p.isP1)continue;
    if(dist(p,other)<55&&other.hasBall){
      const chance=p.stats.def*9+(p.turboActive?15:0);
      if(rnd(0,100)<chance){
        other.hasBall=false;ball.owner=null;ball.loose=true;
        ball.x=other.x;ball.y=other.y;ball.z=15;
        ball.vx=(p.x-other.x)*0.12;ball.vy=(p.y-other.y)*0.12;ball.vz=3;
        sfxSteal();announce('STOLEN!',60);
        other.fireStreak=0;other.onFire=false;
        shotClockTimer=SHOT_CLOCK;
      }
      break;
    }
  }
}

// ============================================================
//  IMPROVED AI — No more dunk loops
// ============================================================
function updateAI(p){
  p.aiTimer++;
  if(p.stumble>0||p.dunking||p.shooting||p.anim||possessionLocked)return;
  const myTeamHasBall=getTeamWithBall()===(p.isP1?'p1':'p2');
  const hoop=getTargetHoop(p);
  const spd=p.speed*(p.turboActive?1.5:1)*(p.onFire?1.12:1);

  // Cooldowns
  if(p.shoveCooldown>0)p.shoveCooldown--;
  if(p.stealCooldown>0)p.stealCooldown--;

  // Decision timer - prevents rapid-fire actions
  p.aiDecisionTimer--;

  if(myTeamHasBall){
    if(p.hasBall){
      // --- AI WITH BALL: smarter offense ---
      const dToHoop=dist(p,hoop);
      const enemies=players.filter(e=>e.isP1!==p.isP1);
      const nearestEnemy=enemies.reduce((closest,e)=>dist(p,e)<dist(p,closest)?e:closest,enemies[0]);
      const enemyDist=nearestEnemy?dist(p,nearestEnemy):999;

      // Use turbo when driving
      p.turboActive=p.turbo>20&&dToHoop<280&&enemyDist>60;

      if(p.aiDecisionTimer<=0){
        p.aiDecisionTimer=rndInt(15,35); // Think every ~0.25-0.6 sec

        // Decision tree
        if(dToHoop<90&&p.z===0&&enemyDist>35){
          if(p.stats.dunk>=5&&dToHoop<110){attemptDunk(p)}else{attemptShot(p)}return;
        }else if(dToHoop<160&&p.z===0&&p.stats.threePt>=7&&rnd(0,1)<0.3){
          // Mid-range jumper
          attemptShot(p);return;
        }else if(dToHoop>200&&isThreePoint(p)&&p.stats.threePt>=8&&rnd(0,1)<0.15){
          // Three pointer if skilled
          attemptShot(p);return;
        }else if(p.onFire&&dToHoop<250&&rnd(0,1)<0.25){
          // On fire = more aggressive
          attemptShot(p);return;
        }else if(enemyDist<45&&rnd(0,1)<0.4){
          // Defender close - pass to teammate
          passBall(p);return;
        }
      }

      // Move toward hoop with weaving
      const angle=Math.atan2(hoop.y-p.y,hoop.x-p.x)+Math.sin(p.aiTimer*0.04)*0.4;
      p.vx=Math.cos(angle)*spd*0.75;
      p.vy=Math.sin(angle)*spd*0.75;
      p.facing=p.vx>0?1:-1;

    }else{
      // AI teammate without ball — get open
      const carrier=players.find(pp=>pp.hasBall&&pp.isP1===p.isP1);
      const offset=p.slot===0?-90:90;
      let tgtX=hoop.x+(p.isP1?-160:160)+Math.sin(p.aiTimer*0.025)*60;
      let tgtY=hoop.y+offset+Math.cos(p.aiTimer*0.03)*40;
      tgtX=clamp(tgtX,COURT.x+40,COURT.x+COURT.w-40);
      tgtY=clamp(tgtY,COURT.y+40,COURT.y+COURT.h-40);
      const dx=tgtX-p.x,dy=tgtY-p.y,d=Math.hypot(dx,dy);
      if(d>15){p.vx=(dx/d)*spd*0.6;p.vy=(dy/d)*spd*0.6;p.facing=dx>0?1:-1}
      else{p.vx*=0.8;p.vy*=0.8}
    }
  }else{
    // --- DEFENSE ---
    const opponents=players.filter(pp=>pp.isP1!==p.isP1);
    const myTarget=opponents[p.slot]||opponents[0];
    const myHoop=p.isP1?{x:COURT.hoopLeftX,y:COURT.hoopY}:{x:COURT.hoopRightX,y:COURT.hoopY};

    // Guard between target and our hoop
    const guardX=lerp(myTarget.x,myHoop.x,0.35);
    const guardY=lerp(myTarget.y,myHoop.y,0.3);
    const gdx=guardX-p.x,gdy=guardY-p.y,gd=Math.hypot(gdx,gdy);
    if(gd>12){p.vx=(gdx/gd)*spd*0.65;p.vy=(gdy/gd)*spd*0.65;p.facing=myTarget.x>p.x?1:-1}
    else{p.vx*=0.8;p.vy*=0.8}

    // Turbo on defense when close
    p.turboActive=p.turbo>25&&dist(p,myTarget)<80;

    const targetDist=dist(p,myTarget);
    // Steal attempt
    if(myTarget.hasBall&&targetDist<50&&p.stealCooldown<=0&&p.aiDecisionTimer<=0&&rnd(0,1)<0.12){
      doSteal(p);p.aiDecisionTimer=rndInt(30,50);
    }
    // Shove attempt
    if(targetDist<45&&p.shoveCooldown<=0&&p.aiDecisionTimer<=0&&rnd(0,1)<0.06){
      doShove(p);p.aiDecisionTimer=rndInt(40,60);
    }
    // Block during extended dunk hang time
    if(myTarget.anim&&myTarget.anim.type==='DUNK_EXTENDED'&&
       myTarget.anim.fc>=35&&myTarget.anim.fc<=90&&
       targetDist<65&&p.z===0&&!p.anim&&p.aiDecisionTimer<=0&&rnd(0,1)<0.25){
      startAnim(p,'BLOCK');p.aiDecisionTimer=rndInt(30,50);
    }
    // Contest jump shots! AI uses the contest meter system
    if(p.contestMeter.target&&p.contestMeter.target.anim&&
       p.contestMeter.target.anim.type==='JUMP_SHOT'&&
       !p.contestMeter.active&&!p.anim&&p.z===0&&p.aiDecisionTimer<=0){
      const contestChance=0.15+(p.stats.def||5)*0.06; // better defenders contest more
      if(rnd(0,1)<contestChance){
        attemptContest(p);
        // AI locks contest meter at skill-weighted position
        const defSkill=p.stats.def||5;
        const variance=40-defSkill*3;
        p.contestMeter.fill=50+rnd(-variance,variance);
        p.contestMeter.locked=true;
        p.aiDecisionTimer=rndInt(20,40);
      }
    }
    // Chase loose ball
    if(ball.loose&&!ball.shotInFlight&&!possessionLocked&&dist(p,ball)<100){
      const dx=ball.x-p.x,dy=ball.y-p.y,d=Math.hypot(dx,dy);
      if(d>5){p.vx=(dx/d)*spd*0.9;p.vy=(dy/d)*spd*0.9}
    }
  }
}

// --- Player Update ---
function updatePlayers(){
  for(const p of players){
    p.animTimer++;
    if(p.animTimer>8){p.animTimer=0;p.animFrame=(p.animFrame+1)%4}
    if(p.flashTimer>0)p.flashTimer--;
    if(p.stumble>0){p.stumble--;p.vx*=0.88;p.vy*=0.88}
    if(!p.turboActive&&p.turbo<100)p.turbo=Math.min(100,p.turbo+0.25);
    if(p.shoveCooldown>0)p.shoveCooldown--;
    if(p.stealCooldown>0)p.stealCooldown--;

    // Record motion trail (every 3 frames when moving fast, during anims, or turbo)
    p.trailTimer++;
    const speed=Math.sqrt(p.vx*p.vx+p.vy*p.vy);
    const shouldTrail=speed>2.5||p.turboActive||p.dunking||p.blocking||(p.anim&&(p.anim.type==='DUNK'||p.anim.type==='DUNK_EXTENDED'||p.anim.type==='BLOCK'));
    if(shouldTrail&&p.trailTimer>=3){
      p.trail.push({x:p.x,y:p.y,z:p.z,scY:p.animScY||1,scX:p.animScX||1,life:12});
      if(p.trail.length>5)p.trail.shift();
      p.trailTimer=0;
    }
    // Decay trail
    for(let ti=p.trail.length-1;ti>=0;ti--){p.trail[ti].life--;if(p.trail[ti].life<=0)p.trail.splice(ti,1);}

    // Animation system (overrides old dunk/shoot/shove timers)
    if(p.anim){
      const animActive=updateAnim(p);
      if(animActive&&(p.anim&&(p.anim.type==='DUNK'||p.anim.type==='DUNK_EXTENDED'||p.anim.type==='JUMP_SHOT'||p.anim.type==='BLOCK'))){
        // Run cycle still updates for visual
        if(Math.abs(p.vx)>0.5||Math.abs(p.vy)>0.5){p.runCycle+=0.2}
        continue;// skip normal physics for these
      }
    }

    // Jump (only when not in animation)
    if(p.z>0||p.vz>0){p.z+=p.vz;p.vz-=0.42;if(p.z<=0){p.z=0;p.vz=0}}

    // Run cycle
    if(Math.abs(p.vx)>0.5||Math.abs(p.vy)>0.5){p.runCycle+=0.2}

    // Shot meter oscillation
    if(p.shotMeter.active&&!p.shotMeter.locked){
      p.shotMeter.fill+=p.shotMeter.dir*p.shotMeter.speed;
      if(p.shotMeter.fill>=100){p.shotMeter.fill=100;p.shotMeter.dir=-1}
      if(p.shotMeter.fill<=0){p.shotMeter.fill=0;p.shotMeter.dir=1}
    }
    // Contest meter oscillation (defender)
    if(p.contestMeter.active&&!p.contestMeter.locked){
      p.contestMeter.fill+=p.contestMeter.dir*p.contestMeter.speed;
      if(p.contestMeter.fill>=100){p.contestMeter.fill=100;p.contestMeter.dir=-1}
      if(p.contestMeter.fill<=0){p.contestMeter.fill=0;p.contestMeter.dir=1}
    }
    // Clear contest target if shooter no longer shooting
    if(p.contestMeter.target&&(!p.contestMeter.target.anim||p.contestMeter.target.anim.type!=='JUMP_SHOT')){
      p.contestMeter.active=false;p.contestMeter.target=null;
    }

    // Player-controlled
    if(p.controlled&&p.isP1&&p.stumble<=0&&!possessionLocked&&!p.anim){
      let mx=0,my=0;
      if(keys['ArrowLeft']||keys['KeyA'])mx=-1;
      if(keys['ArrowRight']||keys['KeyD'])mx=1;
      if(keys['ArrowUp']||keys['KeyW'])my=-1;
      if(keys['ArrowDown']||keys['KeyS'])my=1;
      p.turboActive=(keys['ShiftLeft']||keys['ShiftRight'])&&p.turbo>0;
      if(p.turboActive){p.turbo-=0.7;if(p.turbo<=0)p.turboActive=false}
      const spd=p.speed*(p.turboActive?1.6:1)*(p.onFire?1.12:1);
      if(mx||my){
        const len=Math.hypot(mx,my);
        p.vx=(mx/len)*spd;p.vy=(my/len)*spd;
        p.facing=mx>0?1:mx<0?-1:p.facing;
      }else{p.vx*=0.7;p.vy*=0.7}

      // --- SHOOT / DUNK (Space/Z) ---
      if((keys['Space']||keys['KeyZ'])&&p.hasBall&&p.z===0){
        const now=performance.now();
        if(now-p.lastSpaceTime<350){
          // Double-tap detected — cancel pending shot, attempt dunk
          if(p._shotPending){clearTimeout(p._shotPending);p._shotPending=null}
          if(p.anim&&p.anim.type==='JUMP_SHOT'&&p.anim.fc<15){endAnim(p)} // cancel early jump shot
          if(!p.anim)attemptDunk(p);
          p.lastSpaceTime=0;
        }else{
          // First tap — buffer for 350ms to check for double-tap
          p.lastSpaceTime=now;
          const pendingTime=now;
          p._shotPending=setTimeout(()=>{
            // Only fire if still the same tap sequence and no dunk happened
            if(p.lastSpaceTime===pendingTime&&!p.anim&&p.hasBall&&p.z===0){
              attemptShot(p);
            }
            p._shotPending=null;
          },360);
        }
        keys['Space']=false;keys['KeyZ']=false;
      }
      // --- PASS / STEAL (X/C) ---
      if(keys['KeyX']||keys['KeyC']){
        if(p.hasBall){
          passBall(p);
        }else{
          // Check if teammate has ball — call for pass
          const tm=players.find(pp=>pp.isP1===p.isP1&&pp!==p&&pp.hasBall);
          if(tm&&!possessionLocked){
            passBall(tm); // teammate passes to us
          }else{
            doSteal(p);
          }
        }
        keys['KeyX']=false;keys['KeyC']=false;
      }
      // --- CONTEST or SHOVE (Space without ball) ---
      if((keys['Space']||keys['KeyZ'])&&!p.hasBall&&p.z===0){
        // Check if there's a shooter nearby to contest
        if(p.contestMeter.target&&p.contestMeter.target.anim&&p.contestMeter.target.anim.type==='JUMP_SHOT'&&!p.contestMeter.active){
          attemptContest(p);
        }else{
          doShove(p);
        }
        keys['Space']=false;keys['KeyZ']=false;
      }
      // --- SWITCH PLAYER ---
      if(keys['KeyQ']||keys['Tab']){switchControlledPlayer();keys['KeyQ']=false;keys['Tab']=false}
    }
    // --- PASS / STEAL / SWITCH also work during animations ---
    else if(p.controlled&&p.isP1&&p.stumble<=0&&!possessionLocked){
      // Player has an animation playing — still allow pass, steal, switch
      if(keys['KeyX']||keys['KeyC']){
        if(p.hasBall){passBall(p);if(p.anim)endAnim(p)}
        else{
          // Call for pass from teammate
          const tm=players.find(pp=>pp.isP1===p.isP1&&pp!==p&&pp.hasBall);
          if(tm)passBall(tm);
        }
        keys['KeyX']=false;keys['KeyC']=false;
      }
      if(keys['KeyQ']||keys['Tab']){switchControlledPlayer();keys['KeyQ']=false;keys['Tab']=false}
    }else if(!p.isP1||!p.controlled){
      updateAI(p);
    }

    p.x+=p.vx;p.y+=p.vy;
    p.x=clamp(p.x,COURT.x+20,COURT.x+COURT.w-20);
    p.y=clamp(p.y,COURT.y+20,COURT.y+COURT.h-20);

    // Collision
    for(const other of players){
      if(other===p)continue;
      const d=dist(p,other);
      if(d<26&&d>0){
        const nx=(p.x-other.x)/d,ny=(p.y-other.y)/d;
        const push=(26-d)*0.5;
        p.x+=nx*push;p.y+=ny*push;
        other.x-=nx*push;other.y-=ny*push;
      }
    }
  }
}

// --- Particles ---
function spawnScoreParticles(x,y){
  // Score burst
  for(let i=0;i<25;i++)particles.push({x,y,vx:rnd(-5,5),vy:rnd(-7,-1),life:rnd(25,55),maxLife:55,color:`hsl(${rnd(30,60)},100%,${rnd(50,80)}%)`,size:rnd(3,8)});
  // Confetti shower
  for(let i=0;i<20;i++){
    const hue=rnd(0,360);
    particles.push({x:x+rnd(-60,60),y:y+rnd(-30,10),vx:rnd(-3,3),vy:rnd(-5,-1),life:rnd(40,80),maxLife:80,
      color:`hsl(${hue},90%,65%)`,size:rnd(3,7),confetti:true});
  }
}
function spawnDunkParticles(x,y){for(let i=0;i<40;i++)particles.push({x,y,vx:rnd(-7,7),vy:rnd(-9,2),life:rnd(25,65),maxLife:65,color:`hsl(${rnd(0,40)},100%,${rnd(40,70)}%)`,size:rnd(4,12)})}
function spawnHitParticles(x,y){
  for(let i=0;i<15;i++)particles.push({x,y,vx:rnd(-4,4),vy:rnd(-4,4),life:rnd(10,28),maxLife:28,color:'#FFF',size:rnd(2,6)});
  // Comic-book star burst
  particles.push({x,y,vx:0,vy:0,life:12,maxLife:12,color:'#FFE040',size:35,star:true});
}
function spawnFireParticles(x,y){particles.push({x:x+rnd(-10,10),y:y+rnd(-5,5),vx:rnd(-0.8,0.8),vy:rnd(-4.5,-2),life:22,maxLife:22,color:`hsl(${rnd(0,45)},100%,60%)`,size:rnd(5,13),flame:true})}
function updateParticles(){for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life--;if(p.life<=0)particles.splice(i,1)}}

// ============================================================
//  DRAWING — BIG HEAD / SMALL BODY STYLE
// ============================================================

// --- Perspective Court Drawing ---
// Helper: draw a line between two projected points
function perspLine(x1,y1,x2,y2){
  const a=perspProject(x1,y1),b=perspProject(x2,y2);
  ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();
}

// Helper: draw a filled quad from 4 flat-space corners
function perspQuad(x1,y1,x2,y2,x3,y3,x4,y4){
  const a=perspProject(x1,y1),b=perspProject(x2,y2),c=perspProject(x3,y3),d=perspProject(x4,y4);
  ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.lineTo(c.x,c.y);ctx.lineTo(d.x,d.y);ctx.closePath();
}

function drawCourt(){
  const cx=COURT.x,cy=COURT.y,cw=COURT.w,ch=COURT.h;
  const cr=cx+cw,cb=cy+ch;

  // ── Wood floor with alternating plank colors & grain ──
  const plankColors=['#C6884A','#BA7D42','#D09555','#B5763E','#C88F50','#AE7238'];
  let plankY=cy;
  let pi=0;
  while(plankY<cb){
    const ph=10+Math.sin(pi*0.7)*3;// vary plank height
    const nextY=Math.min(plankY+ph,cb);
    ctx.fillStyle=plankColors[pi%plankColors.length];
    perspQuad(cx,plankY,cr,plankY,cr,nextY,cx,nextY);ctx.fill();
    // Plank gap (dark line)
    ctx.strokeStyle='rgba(80,45,15,0.5)';ctx.lineWidth=0.8;
    perspLine(cx,nextY,cr,nextY);
    // Subtle grain within plank
    ctx.strokeStyle='rgba(100,60,20,0.18)';ctx.lineWidth=0.5;
    const mid=plankY+ph*0.5;
    perspLine(cx,mid,cr,mid);
    plankY=nextY;pi++;
  }

  // ── Court spotlight (radial glow from center) ──
  const ctrP=perspProject(COURT.centerX,COURT.centerY);
  ctx.save();
  const spotGrad=ctx.createRadialGradient(ctrP.x,ctrP.y,30,ctrP.x,ctrP.y,350);
  spotGrad.addColorStop(0,'rgba(255,245,220,0.18)');
  spotGrad.addColorStop(0.5,'rgba(255,235,200,0.08)');
  spotGrad.addColorStop(1,'rgba(0,0,0,0.12)');
  ctx.fillStyle=spotGrad;
  ctx.fillRect(0,100,W,500);
  ctx.restore();

  // ── Darker edge strips for depth ──
  ctx.fillStyle='rgba(0,0,0,0.12)';
  perspQuad(cx,cy,cx+35,cy,cx+35,cb,cx,cb);ctx.fill();
  perspQuad(cr-35,cy,cr,cy,cr,cb,cr-35,cb);ctx.fill();
  // Near edge darkening
  ctx.fillStyle='rgba(0,0,0,0.06)';
  perspQuad(cx,cb-30,cr,cb-30,cr,cb,cx,cb);ctx.fill();

  // ── Court border (glowing white) ──
  ctx.strokeStyle='rgba(255,255,255,0.85)';ctx.lineWidth=2.5;
  ctx.shadowColor='rgba(255,255,255,0.3)';ctx.shadowBlur=6;
  perspQuad(cx,cy,cr,cy,cr,cb,cx,cb);ctx.stroke();
  ctx.shadowBlur=0;

  // ── Center line ──
  ctx.strokeStyle='rgba(255,255,255,0.8)';ctx.lineWidth=2.5;
  perspLine(COURT.centerX,cy,COURT.centerX,cb);

  // ── Center circle (smooth) ──
  ctx.strokeStyle='rgba(255,255,255,0.75)';ctx.lineWidth=2.5;
  ctx.beginPath();
  for(let a=0;a<=Math.PI*2;a+=0.08){
    const px=COURT.centerX+Math.cos(a)*55;
    const py=COURT.centerY+Math.sin(a)*55;
    const pp=perspProject(px,py);
    if(a===0)ctx.moveTo(pp.x,pp.y);else ctx.lineTo(pp.x,pp.y);
  }
  ctx.closePath();ctx.stroke();
  // Center circle fill (subtle team color)
  ctx.fillStyle='rgba(200,50,50,0.06)';
  ctx.fill();

  // ── Three-point arcs (smoother) ──
  ctx.strokeStyle='rgba(255,255,255,0.7)';ctx.lineWidth=2.5;
  ctx.beginPath();
  for(let a=-0.42;a<=0.42;a+=0.04){
    const px=COURT.hoopLeftX+Math.cos(a)*COURT.threeLineR;
    const py=COURT.hoopY+Math.sin(a)*COURT.threeLineR;
    const pp=perspProject(px,py);
    if(a<=-0.4)ctx.moveTo(pp.x,pp.y);else ctx.lineTo(pp.x,pp.y);
  }
  ctx.stroke();
  ctx.beginPath();
  for(let a=Math.PI-0.42;a<=Math.PI+0.42;a+=0.04){
    const px=COURT.hoopRightX+Math.cos(a)*COURT.threeLineR;
    const py=COURT.hoopY+Math.sin(a)*COURT.threeLineR;
    const pp=perspProject(px,py);
    if(a<=Math.PI-0.4)ctx.moveTo(pp.x,pp.y);else ctx.lineTo(pp.x,pp.y);
  }
  ctx.stroke();

  // ── Keys (painted areas with crosshatch) ──
  const keyL=[cx,COURT.hoopY-65,cx+85,COURT.hoopY+65];
  const keyR=[cr-85,COURT.hoopY-65,cr,COURT.hoopY+65];
  [keyL,keyR].forEach(k=>{
    // Red fill
    ctx.fillStyle='rgba(180,30,30,0.22)';
    perspQuad(k[0],k[1],k[2],k[1],k[2],k[3],k[0],k[3]);ctx.fill();
    // Crosshatch lines inside key
    ctx.strokeStyle='rgba(180,30,30,0.12)';ctx.lineWidth=0.8;
    for(let y=k[1]+8;y<k[3];y+=10)perspLine(k[0],y,k[2],y);
    for(let x=k[0]+10;x<k[2];x+=12)perspLine(x,k[1],x,k[3]);
    // Border
    ctx.strokeStyle='rgba(255,255,255,0.65)';ctx.lineWidth=2.5;
    perspQuad(k[0],k[1],k[2],k[1],k[2],k[3],k[0],k[3]);ctx.stroke();
  });

  // ── Hoops ──
  drawHoop(COURT.hoopLeftX,COURT.hoopY,-1);
  drawHoop(COURT.hoopRightX,COURT.hoopY,1);
}

function drawHoop(x,y,dir){
  const pp=perspProject(x,y);
  const sc=pp.scale;
  const bx=pp.x+dir*12*sc, by=pp.y;
  // Backboard support pole
  ctx.strokeStyle='#666';ctx.lineWidth=3*sc;
  ctx.beginPath();ctx.moveTo(bx+dir*3*sc,by-28*sc);ctx.lineTo(bx+dir*3*sc,by+28*sc);ctx.stroke();
  // Backboard (glass look with gradient)
  ctx.save();
  const bbGrad=ctx.createLinearGradient(bx,by-24*sc,bx+6*sc,by+24*sc);
  bbGrad.addColorStop(0,'rgba(220,230,255,0.92)');bbGrad.addColorStop(0.4,'rgba(180,200,230,0.85)');
  bbGrad.addColorStop(0.6,'rgba(200,215,240,0.88)');bbGrad.addColorStop(1,'rgba(160,180,210,0.8)');
  ctx.fillStyle=bbGrad;
  ctx.fillRect(bx-1*sc,by-24*sc,6*sc,48*sc);
  // Backboard border
  ctx.strokeStyle='#AAA';ctx.lineWidth=1.5*sc;
  ctx.strokeRect(bx-1*sc,by-24*sc,6*sc,48*sc);
  // Backboard target square
  ctx.strokeStyle='rgba(255,60,0,0.6)';ctx.lineWidth=1.2*sc;
  ctx.strokeRect(bx,by-10*sc,4*sc,20*sc);
  // Glass reflection line
  ctx.strokeStyle='rgba(255,255,255,0.35)';ctx.lineWidth=0.8*sc;
  ctx.beginPath();ctx.moveTo(bx+1*sc,by-20*sc);ctx.lineTo(bx+4*sc,by+16*sc);ctx.stroke();
  ctx.restore();
  // Rim — 3D double ring
  const rimCx=pp.x-dir*8*sc, rimCy=pp.y;
  ctx.strokeStyle='#CC2200';ctx.lineWidth=4*sc;
  ctx.beginPath();ctx.ellipse(rimCx,rimCy+1*sc,16*sc,10*sc,0,0,Math.PI*2);ctx.stroke();
  ctx.strokeStyle='#FF4400';ctx.lineWidth=3.5*sc;
  ctx.beginPath();ctx.ellipse(rimCx,rimCy,15*sc,9*sc,0,0,Math.PI*2);ctx.stroke();
  ctx.strokeStyle='#FF6622';ctx.lineWidth=1.5*sc;
  ctx.beginPath();ctx.ellipse(rimCx,rimCy-0.5*sc,13*sc,7.5*sc,0,0,Math.PI*2);ctx.stroke();
  // Rim connector to backboard
  ctx.strokeStyle='#AA3300';ctx.lineWidth=2*sc;
  ctx.beginPath();ctx.moveTo(rimCx+dir*15*sc,rimCy);ctx.lineTo(bx,rimCy);ctx.stroke();
  // Net — thicker with taper and cross-threads
  const netTop=rimCy+9*sc, netBot=rimCy+32*sc;
  for(let i=-4;i<=4;i++){
    const topX=rimCx+i*3.5*sc;
    const botX=rimCx+i*1.8*sc;
    const thick=1.2-Math.abs(i)*0.1;
    ctx.strokeStyle=`rgba(255,255,255,${0.55-Math.abs(i)*0.04})`;ctx.lineWidth=thick*sc;
    ctx.beginPath();ctx.moveTo(topX,netTop);ctx.quadraticCurveTo((topX+botX)/2,netTop+(netBot-netTop)*0.6,botX,netBot);ctx.stroke();
  }
  // Net horizontal cross-threads
  for(let r=0;r<3;r++){
    const ny=netTop+(netBot-netTop)*(0.3+r*0.25);
    const spread=lerp(3.5,1.8,(0.3+r*0.25));
    ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=0.6*sc;
    ctx.beginPath();ctx.moveTo(rimCx-4*spread*sc,ny);ctx.lineTo(rimCx+4*spread*sc,ny);ctx.stroke();
  }
  // Rim shadow on court
  ctx.fillStyle='rgba(0,0,0,0.15)';
  ctx.beginPath();ctx.ellipse(rimCx+3*sc,rimCy+38*sc,14*sc,4*sc,0,0,Math.PI*2);ctx.fill();
}

// ============================================================
//  MEGA BIG HEAD — CUSTOM BEZIER CONTOUR PER PLAYER
//  Each player has a unique head silhouette you can recognize
// ============================================================
function getLooks(p){
  return PLAYER_LOOKS[p.stats.name]||{skin:'#B08060',skinD:'#907050',skinL:'#D0A080',
    headW:1,headH:1,earSz:0.9,eyeSz:1,noseW:1,beard:'none',beardC:'',
    hairC:'#1A1A1A',eyeC:'#3A2200',id:'generic'};
}

function drawPlayerTrails(p){
  // Motion trail afterimages
  if(p.trail.length===0)return;
  const c1=p.team.color1;
  for(const t of p.trail){
    const alpha=t.life/12*0.2;
    ctx.save();ctx.globalAlpha=alpha;
    ctx.fillStyle=c1;
    const tx=t.x, ty=t.y-t.z;
    // Simplified ghost: torso blob + head blob
    ctx.fillRect(tx-10*t.scX,ty-10*t.scY,20*t.scX,16*t.scY);
    ctx.beginPath();ctx.ellipse(tx,ty-30,20,20,0,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

function drawTurboLines(p){
  // Speed lines behind player when turbo active
  if(!p.turboActive)return;
  const spd=Math.sqrt(p.vx*p.vx+p.vy*p.vy);
  if(spd<1.5)return;
  ctx.save();
  const ang=Math.atan2(p.vy,p.vx);
  for(let i=0;i<5;i++){
    const offset=(i-2)*8;
    const lineLen=15+spd*3+Math.random()*10;
    const sx=p.x-Math.cos(ang)*lineLen+Math.sin(ang)*offset;
    const sy=(p.y-p.z-10)-Math.sin(ang)*lineLen-Math.cos(ang)*offset;
    ctx.strokeStyle=`rgba(255,255,255,${0.15+Math.random()*0.1})`;
    ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(p.x+Math.sin(ang)*offset,p.y-p.z-10-Math.cos(ang)*offset);ctx.lineTo(sx,sy);ctx.stroke();
  }
  ctx.restore();
}

function drawPlayer(p){
  ctx.save();
  const mainCtx=ctx; // Save main context for later
  const sx=p.x, sy=p.y-p.z;
  const lk=getLooks(p);
  const R=38; // RETRO: larger head radius
  const hw=R*lk.headW, hh=R*lk.headH; // ellipse radii
  const OL=4.0; // RETRO: thicker outline for arcade look
  const sk=lk.skin, skD=lk.skinD, skL=lk.skinL;
  const fDir=p.facing;
  const pid=lk.id;

  // --- Dynamic Ground Shadow (stretches/fades with height) - ON MAIN CANVAS ---
  const shSc=1+p.z*0.012;
  const shAlpha=Math.max(0.08,0.35-p.z*0.004);
  const shOff=p.z*0.15;
  mainCtx.fillStyle=`rgba(0,0,0,${shAlpha})`;
  mainCtx.beginPath();mainCtx.ellipse(p.x+shOff,p.y+20,18+p.z*0.3,6+p.z*0.08,0,0,Math.PI*2);mainCtx.fill();
  if(p.z>5){mainCtx.fillStyle=`rgba(0,0,0,${shAlpha*0.4})`;
  mainCtx.beginPath();mainCtx.ellipse(p.x+shOff*1.3,p.y+20,24+p.z*0.4,8+p.z*0.1,0,0,Math.PI*2);mainCtx.fill();}

  // Fire particles
  if(p.onFire){spawnFireParticles(sx+rnd(-12,12),sy-hh*2-10);spawnFireParticles(sx+rnd(-8,8),sy-hh*2);spawnFireParticles(sx+rnd(-5,5),sy-hh*2+5)}

  // Stumble tilt
  if(p.stumble>0){mainCtx.translate(sx,sy);mainCtx.rotate(Math.sin(p.stumble*0.5)*0.4);mainCtx.translate(-sx,-sy)}
  if(p.flashTimer>0&&p.flashTimer%4<2)mainCtx.globalAlpha=0.5;

  // === PIXELATION SETUP ===
  const PIX=3; // pixel scale factor
  const sprW=140, sprH=180; // offscreen sprite size
  if(!p._pixCvs){p._pixCvs=document.createElement('canvas');p._pixCvs.width=Math.ceil(sprW/PIX);p._pixCvs.height=Math.ceil(sprH/PIX);}
  const pixCanvas=p._pixCvs;
  ctx=pixCanvas.getContext('2d'); // SWAP ctx to pixelated canvas
  ctx.clearRect(0,0,pixCanvas.width,pixCanvas.height);
  ctx.save();
  ctx.scale(1/PIX,1/PIX);
  const offX=sprW/2-sx, offY=sprH*0.65-sy;
  ctx.translate(offX,offY);
  // From now on, all ctx calls draw to pixCanvas at 1/3 scale, then we blit back

  const legPhase=Math.sin(p.runCycle);
  const moving=Math.abs(p.vx)>0.6||Math.abs(p.vy)>0.6;
  const c1=p.team.color1, c2=p.team.color2;
  const shoeC=c2==='#000000'?'#333':c2;

  // Helper: outlined ellipse
  function oEllipse(cx,cy,rx,ry,fill){
    ctx.fillStyle='#000';ctx.beginPath();ctx.ellipse(cx,cy,rx+OL,ry+OL,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=fill;ctx.beginPath();ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);ctx.fill();
  }
  // Helper: outlined rounded rect
  function oRoundRect(x,y,w,h,r,fill){
    ctx.fillStyle='#000';roundRect(x-OL,y-OL,w+OL*2,h+OL*2,r+1);ctx.fill();
    ctx.fillStyle=fill;roundRect(x,y,w,h,r);ctx.fill();
  }
  // Helper: outlined rect
  function oRect(x,y,w,h,fill){
    ctx.fillStyle='#000';ctx.fillRect(x-OL,y-OL,w+OL*2,h+OL*2);
    ctx.fillStyle=fill;ctx.fillRect(x,y,w,h);
  }

  // ============ BODY (with squash/stretch) — RETRO ARCADE BUILD ============
  const bScY=p.animScY||1, bScX=p.animScX||1;
  const aPhase=p.anim?p.anim.phase:null;
  const aType=p.anim?p.anim.type:null;
  const aFip=p.anim?p.anim.fip:0;
  const aFc=p.anim?p.anim.fc:0;

  // Body dimensions — RETRO proportions (blockier, chunkier)
  const shoulderW=32*bScX; // 28 -> 32
  const waistW=26*bScX;    // 20 -> 26
  const torsoTop=sy-14*bScY;
  const torsoH=16*bScY;    // 22 -> 16 (shorter torso)
  const hipY=torsoTop+torsoH;
  const upperArmW=9*bScX, forearmW=8*bScX;     // 7,6 -> 9,8
  const upperArmLen=9*bScY, forearmLen=8*bScY; // 12,11 -> 9,8
  const armTop=torsoTop+3;
  const thighW=8*bScX, calfW=6*bScX;
  const thighLen=8*bScY, calfLen=7*bScY;       // 12,10 -> 8,7

  // Helper: draw default relaxed arms (upper + forearm + hand)
  function drawDefaultArms(ax,aTop,sw,uaW,faW,uaL,faL,swing,skC,skLC){
    // Left arm
    oRect(ax-sw/2-uaW,aTop+swing,uaW,uaL,skC);
    oRect(ax-sw/2-faW,aTop+swing+uaL,faW,faL,skC);
    oEllipse(ax-sw/2-faW/2,aTop+swing+uaL+faL,4,4,skC);
    // Right arm
    oRect(ax+sw/2,aTop-swing,uaW,uaL,skC);
    oRect(ax+sw/2+1,aTop-swing+uaL,faW,faL,skC);
    oEllipse(ax+sw/2+faW/2+1,aTop-swing+uaL+faL,4,4,skC);
  }

  // LEGS — thigh + calf with knee bend
  let legSpread=0;
  if(aPhase==='CROUCH'||aPhase==='LAND'||aPhase==='GATHER')legSpread=5*bScX;
  else if(aPhase==='RISE'||aPhase==='HANG')legSpread=-2;
  const lL=moving&&!aType?legPhase*5:0, rL=moving&&!aType?-legPhase*5:0;

  // Left thigh
  oRect(sx-8-legSpread,hipY+1,thighW,thighLen+lL*0.5,sk);
  // Left calf
  oRect(sx-7-legSpread,hipY+1+thighLen+lL*0.5,calfW,calfLen+lL*0.5,sk);
  // Right thigh
  oRect(sx+legSpread,hipY+1,thighW,thighLen+rL*0.5,sk);
  // Right calf
  oRect(sx+1+legSpread,hipY+1+thighLen+rL*0.5,calfW,calfLen+rL*0.5,sk);

  // SHOES — high-tops
  const lShoeY=hipY+1+thighLen+lL*0.5+calfLen+lL*0.5;
  const rShoeY=hipY+1+thighLen+rL*0.5+calfLen+rL*0.5;
  oRect(sx-8-legSpread,lShoeY-3,thighW,4,shoeC);
  oRect(sx+legSpread,rShoeY-3,thighW,4,shoeC);
  oRoundRect(sx-9-legSpread,lShoeY,thighW+2,6,2,shoeC);
  oRoundRect(sx-1+legSpread,rShoeY,thighW+2,6,2,shoeC);
  ctx.fillStyle='#FFF';
  ctx.fillRect(sx-7-legSpread,lShoeY+2,thighW-2,2);
  ctx.fillRect(sx+1+legSpread,rShoeY+2,thighW-2,2);
  ctx.fillStyle=c1;
  ctx.fillRect(sx-9-legSpread,lShoeY+5,thighW+2,2);
  ctx.fillRect(sx-1+legSpread,rShoeY+5,thighW+2,2);

  // SHORTS — simple baggy
  oRoundRect(sx-shoulderW/2-1,hipY-3,shoulderW+2,14*bScY,4,c1);
  ctx.fillStyle=c2;ctx.fillRect(sx-shoulderW/2+2,hipY+8*bScY,shoulderW-4,2);

  // JERSEY TORSO — trapezoidal (broad shoulders, tapered waist)
  ctx.fillStyle='#000';
  ctx.beginPath();
  ctx.moveTo(sx-shoulderW/2-OL,torsoTop-OL);
  ctx.lineTo(sx+shoulderW/2+OL,torsoTop-OL);
  ctx.lineTo(sx+waistW/2+OL,hipY+OL);
  ctx.lineTo(sx-waistW/2-OL,hipY+OL);
  ctx.closePath();ctx.fill();
  ctx.fillStyle=c1;
  ctx.beginPath();
  ctx.moveTo(sx-shoulderW/2,torsoTop);
  ctx.lineTo(sx+shoulderW/2,torsoTop);
  ctx.lineTo(sx+waistW/2,hipY);
  ctx.lineTo(sx-waistW/2,hipY);
  ctx.closePath();ctx.fill();
  // V-neck
  ctx.fillStyle=c2;
  ctx.beginPath();ctx.moveTo(sx-7,torsoTop);ctx.lineTo(sx,torsoTop+9);ctx.lineTo(sx+7,torsoTop);ctx.closePath();ctx.fill();
  // Collar stripe
  ctx.fillStyle=c2;ctx.fillRect(sx-shoulderW/2,torsoTop,shoulderW,3);
  // Jersey number
  ctx.font=`bold ${Math.max(9,12*bScY)}px Arial`;ctx.textAlign='center';
  ctx.fillStyle=c2;ctx.fillText(p.stats.number,sx,torsoTop+torsoH-3);
  // Shoulder caps
  oEllipse(sx-shoulderW/2,torsoTop+4,6*bScX,5*bScY,c1);
  oEllipse(sx+shoulderW/2,torsoTop+4,6*bScX,5*bScY,c1);

  // ============ ARMS (upper arm + forearm + hand) ============
  const armLen=upperArmLen+forearmLen;
  const torsoW=shoulderW;

  if(aType==='DUNK'||aType==='DUNK_EXTENDED'){
    if(aPhase==='CROUCH'){
      oRect(sx-shoulderW/2-upperArmW,armTop+4,upperArmW,upperArmLen,sk);
      oRect(sx-shoulderW/2-forearmW,armTop+4+upperArmLen,forearmW,forearmLen-4,sk);
      oRect(sx+shoulderW/2,armTop+4,upperArmW,upperArmLen,sk);
      oRect(sx+shoulderW/2+1,armTop+4+upperArmLen,forearmW,forearmLen-4,sk);
    }else if(aPhase==='RISE'){
      const ext=Math.min(aFip/12,1);
      const armY=lerp(armTop,torsoTop-18,ext);
      oRect(sx-12,armY,upperArmW,upperArmLen+ext*5,sk);
      oRect(sx-11,armY-forearmLen*ext,forearmW,forearmLen*ext+2,sk);
      oRect(sx+5,armY,upperArmW,upperArmLen+ext*5,sk);
      oRect(sx+6,armY-forearmLen*ext,forearmW,forearmLen*ext+2,sk);
      oEllipse(sx-8,armY-forearmLen*ext,5*ext+2,5*ext+2,sk);
      oEllipse(sx+9,armY-forearmLen*ext,5*ext+2,5*ext+2,sk);
    }else if(aPhase==='HANG'){
      oRect(sx-11,torsoTop-28,upperArmW,upperArmLen+10,sk);
      oRect(sx-10,torsoTop-28-forearmLen+4,forearmW,forearmLen,sk);
      oRect(sx+4,torsoTop-28,upperArmW,upperArmLen+10,sk);
      oRect(sx+5,torsoTop-28-forearmLen+4,forearmW,forearmLen,sk);
      oEllipse(sx-8,torsoTop-32,7,8,sk);
      oEllipse(sx+8,torsoTop-32,7,8,sk);
    }else if(aPhase==='SLAM'){
      const slamT=Math.min(aFip/12,1);
      const armY=lerp(torsoTop-28,torsoTop-6,slamT);
      oRect(sx-9,armY,upperArmW,upperArmLen+8,sk);
      oRect(sx+2,armY,upperArmW,upperArmLen+8,sk);
      oEllipse(sx-6,armY-2,7,7,sk);
      oEllipse(sx+6,armY-2,7,7,sk);
    }else{
      const sw=moving?Math.sin(p.runCycle)*3:0;
      drawDefaultArms(sx,armTop,shoulderW,upperArmW,forearmW,upperArmLen,forearmLen,sw,sk,skL);
    }
  }else if(aType==='JUMP_SHOT'){
    if(aPhase==='GATHER'){
      oRect(sx+fDir*(shoulderW/2),armTop,fDir*14,upperArmW,sk);
      oEllipse(sx+fDir*(shoulderW/2+14),armTop+upperArmW/2,5,5,sk);
      oRect(sx-fDir*(shoulderW/2+upperArmW),armTop+2,upperArmW,upperArmLen,sk);
      oRect(sx-fDir*(shoulderW/2+forearmW),armTop+2+upperArmLen,forearmW,forearmLen-4,sk);
    }else if(aPhase==='RISE'){
      const ext=Math.min(aFip/10,1);
      const upY=lerp(armTop,torsoTop-20,ext);
      oRect(sx+fDir*(shoulderW/2-3),upY,upperArmW,-(upperArmLen+ext*6),sk);
      oRect(sx+fDir*(shoulderW/2-2),upY-(upperArmLen+ext*6),forearmW,-(forearmLen*ext),sk);
      oEllipse(sx+fDir*(shoulderW/2),upY-(upperArmLen+ext*6+forearmLen*ext),5,5,sk);
      oRect(sx-fDir*(shoulderW/2+upperArmW),armTop+1,upperArmW,upperArmLen,sk);
    }else if(aPhase==='HANG'){
      oRect(sx+fDir*5,torsoTop-12,upperArmW,-upperArmLen-6,sk);
      oRect(sx+fDir*5+1,torsoTop-12-upperArmLen-6,forearmW,-forearmLen,sk);
      oEllipse(sx+fDir*6,torsoTop-12-upperArmLen-forearmLen-8,6,6,sk);
      oRect(sx-fDir*7,torsoTop-16,upperArmW,upperArmLen+4,sk);
      oRect(sx-fDir*6,torsoTop-16+upperArmLen,forearmW,6,sk);
    }else if(aPhase==='RELEASE'){
      const flickT=Math.min(aFip/6,1);
      oRect(sx+fDir*6,lerp(torsoTop-30,torsoTop-24,flickT),upperArmW,upperArmLen+8,sk);
      const handX=sx+fDir*(10+flickT*12);
      const handY=torsoTop-28+flickT*8;
      oEllipse(handX,handY,5+flickT*2,5,sk);
      oRect(sx-fDir*6,torsoTop-10+flickT*4,upperArmW,upperArmLen,sk);
      oRect(sx-fDir*5,torsoTop-10+flickT*4+upperArmLen,forearmW,forearmLen-4,sk);
    }else if(aPhase==='LAND'){
      const recT=Math.min(aFip/10,1);
      const armY=lerp(torsoTop-14,armTop,recT);
      oRect(sx+fDir*5,armY,upperArmW,upperArmLen+4*(1-recT),sk);
      oRect(sx-fDir*(shoulderW/2+upperArmW),armTop,upperArmW,upperArmLen,sk);
    }
  }else if(aType==='SHOVE'){
    if(aPhase==='WINDUP'){
      oRect(sx-fDir*(shoulderW/2+upperArmW+3),armTop,upperArmW,upperArmLen,sk);
      oRect(sx-fDir*(shoulderW/2+3),armTop,forearmW,forearmLen-2,sk);
      oRect(sx-fDir*(shoulderW/2+upperArmW),armTop+2,upperArmW,upperArmLen-2,sk);
    }else if(aPhase==='STRIKE'){
      oRect(sx+fDir*(shoulderW/2),armTop-2,fDir*16,upperArmW+2,sk);
      oRect(sx+fDir*(shoulderW/2+16),armTop-3,fDir*10,forearmW+2,sk);
      oEllipse(sx+fDir*(shoulderW/2+26),armTop+upperArmW/2-1,7,7,sk);
      oRect(sx+fDir*(shoulderW/2-4),armTop+2,fDir*14,upperArmW,sk);
      oEllipse(sx+fDir*(shoulderW/2+10),armTop+upperArmW/2+1,6,6,sk);
    }else if(aPhase==='FOLLOW'){
      const recT=Math.min(aFip/8,1);
      const ext=lerp(24,14,recT);
      oRect(sx+fDir*(shoulderW/2),armTop,fDir*ext,upperArmW,sk);
      oEllipse(sx+fDir*(shoulderW/2+ext),armTop+upperArmW/2,5,5,sk);
      oRect(sx-fDir*(shoulderW/2+upperArmW),armTop+1,upperArmW,upperArmLen-3,sk);
    }else if(aPhase==='RECOVER'){
      const recT=Math.min(aFip/8,1);
      const sw=moving?Math.sin(p.runCycle)*3:0;
      drawDefaultArms(sx,armTop,shoulderW,upperArmW,forearmW,upperArmLen,forearmLen,sw*recT,sk,skL);
    }
  }else if(aType==='BLOCK'){
    if(aPhase==='LEAP'){
      const ext=Math.min(aFip/8,1);
      const armY=lerp(armTop,torsoTop-20,ext);
      oRect(sx-14,armY,upperArmW,upperArmLen+ext*8,sk);
      oRect(sx-13,armY-forearmLen*ext,forearmW,forearmLen*ext,sk);
      oRect(sx+7,armY,upperArmW,upperArmLen+ext*8,sk);
      oRect(sx+8,armY-forearmLen*ext,forearmW,forearmLen*ext,sk);
      oEllipse(sx-11,armY-forearmLen*ext-2,5*ext+3,6*ext+3,sk);
      oEllipse(sx+10,armY-forearmLen*ext-2,5*ext+3,6*ext+3,sk);
    }else if(aPhase==='SWAT'){
      oRect(sx-15,torsoTop-26,upperArmW,upperArmLen+12,sk);
      oRect(sx-14,torsoTop-26-forearmLen,forearmW,forearmLen+4,sk);
      oRect(sx+8,torsoTop-26,upperArmW,upperArmLen+12,sk);
      oRect(sx+9,torsoTop-26-forearmLen,forearmW,forearmLen+4,sk);
      oEllipse(sx-12,torsoTop-30-forearmLen,7,8,sk);
      oEllipse(sx+12,torsoTop-30-forearmLen,7,8,sk);
      ctx.strokeStyle=sk;ctx.lineWidth=2;
      for(let f=-1;f<=1;f++){
        ctx.beginPath();ctx.moveTo(sx-12+f*3,torsoTop-32-forearmLen);ctx.lineTo(sx-12+f*5,torsoTop-38-forearmLen);ctx.stroke();
        ctx.beginPath();ctx.moveTo(sx+12+f*3,torsoTop-32-forearmLen);ctx.lineTo(sx+12+f*5,torsoTop-38-forearmLen);ctx.stroke();
      }
    }else if(aPhase==='LAND'){
      const recT=Math.min(aFip/12,1);
      const armY=lerp(torsoTop-14,armTop+2,recT);
      oRect(sx-13,armY,upperArmW,upperArmLen);
      oRect(sx+6,armY,upperArmW,upperArmLen);
    }
  }else if(aType==='STEAL'){
    if(aPhase==='CROUCH'){
      const crouchT=Math.min(aFip/6,1);
      const armY=armTop+crouchT*4;
      oRect(sx-shoulderW/2-upperArmW,armY,upperArmW,upperArmLen,sk);
      oRect(sx-shoulderW/2-forearmW,armY+upperArmLen,forearmW,forearmLen-2,sk);
      oRect(sx+shoulderW/2,armY,upperArmW,upperArmLen,sk);
      oRect(sx+shoulderW/2+1,armY+upperArmLen,forearmW,forearmLen-2,sk);
    }else if(aPhase==='REACH'){
      const reachT=Math.min(aFip/8,1);
      const reachDist=lerp(0,30,reachT);
      oRect(sx+fDir*(shoulderW/2),armTop-3,fDir*reachDist,upperArmW+1,sk);
      if(reachDist>10){
        oRect(sx+fDir*(shoulderW/2+reachDist),armTop-4,fDir*12*reachT,forearmW,sk);
      }
      if(reachT>0.4){
        const handX=sx+fDir*(shoulderW/2+reachDist+12*reachT);
        const handY=armTop-1;
        oEllipse(handX,handY,7,7,sk);
        ctx.strokeStyle=sk;ctx.lineWidth=2.5;
        ctx.beginPath();ctx.moveTo(handX,handY-5);ctx.lineTo(handX+fDir*6,handY-9);ctx.stroke();
        ctx.beginPath();ctx.moveTo(handX+fDir*2,handY-4);ctx.lineTo(handX+fDir*8,handY-6);ctx.stroke();
        ctx.beginPath();ctx.moveTo(handX+fDir*2,handY+3);ctx.lineTo(handX+fDir*7,handY+5);ctx.stroke();
        ctx.strokeStyle='#000';ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(handX,handY-5);ctx.lineTo(handX+fDir*6,handY-9);ctx.stroke();
        ctx.beginPath();ctx.moveTo(handX+fDir*2,handY-4);ctx.lineTo(handX+fDir*8,handY-6);ctx.stroke();
        ctx.beginPath();ctx.moveTo(handX+fDir*2,handY+3);ctx.lineTo(handX+fDir*7,handY+5);ctx.stroke();
      }
      oRect(sx-fDir*(shoulderW/2+upperArmW),armTop+2,upperArmW,upperArmLen,sk);
      oRect(sx-fDir*(shoulderW/2+forearmW),armTop+2+upperArmLen,forearmW,forearmLen-4,sk);
    }else if(aPhase==='SWIPE'){
      const swipeT=Math.min(aFip/10,1);
      const swipeX=sx+fDir*(shoulderW/2+32-swipeT*20);
      oRect(sx+fDir*(shoulderW/2),armTop-4+swipeT*3,fDir*(28-swipeT*12),upperArmW+2,sk);
      oEllipse(swipeX,armTop+swipeT*3,6,6,sk);
      ctx.strokeStyle=`rgba(200,220,255,${0.6*(1-swipeT)})`;ctx.lineWidth=2;
      for(let i=0;i<3;i++){
        const streakX=swipeX+fDir*(5+i*8);
        ctx.beginPath();ctx.moveTo(streakX,armTop-2+swipeT*3);ctx.lineTo(streakX+fDir*12,armTop+swipeT*3);ctx.stroke();
      }
      oRect(sx-fDir*(shoulderW/2+upperArmW),armTop+3,upperArmW,upperArmLen-2,sk);
    }else if(aPhase==='RECOVER'){
      const recT=Math.min(aFip/12,1);
      const sw=moving?Math.sin(p.runCycle)*3:0;
      drawDefaultArms(sx,armTop,shoulderW,upperArmW,forearmW,upperArmLen,forearmLen,sw*recT,sk,skL);
    }
  }else if(p.hasBall){
    oRect(sx+fDir*(shoulderW/2),armTop,fDir*12,upperArmW,sk);
    oRect(sx+fDir*(shoulderW/2+12),armTop-1,fDir*6,forearmW,sk);
    oEllipse(sx+fDir*(shoulderW/2+18),armTop+upperArmW/2-1,5,5,sk);
    oRect(sx-fDir*(shoulderW/2+upperArmW),armTop+1,upperArmW,upperArmLen,sk);
    oRect(sx-fDir*(shoulderW/2+forearmW),armTop+1+upperArmLen,forearmW,forearmLen-4,sk);
  }else{
    const sw=moving?Math.sin(p.runCycle)*6:0;
    drawDefaultArms(sx,armTop,shoulderW,upperArmW,forearmW,upperArmLen,forearmLen,sw,sk,skL);
  }

  // Wristbands
  if(pid==='lebron'||pid==='tatum'||pid==='giannis'){
    ctx.fillStyle=c1;
    ctx.fillRect(sx-shoulderW/2-upperArmW-1,armTop+upperArmLen-1,upperArmW+2,3);
    ctx.fillRect(sx+shoulderW/2-1,armTop+upperArmLen-1,upperArmW+2,3);
  }
  // ============ HUGE HEAD — RETRO ARCADE ============
  const headCY=sy-24; // RETRO: moved up slightly due to shorter torso

  // Neck (simple, outlined)
  oRect(sx-6,torsoTop-7,12,9,sk);

  // EARS (simple outline, no inner detail)
  const earS=lk.earSz;
  const earX=hw+2;
  oEllipse(sx-earX,headCY+2,5*earS,8*earS,sk);
  oEllipse(sx+earX,headCY+2,5*earS,8*earS,sk);

  // HEAD — clean bold outlined ellipse (RETRO: no highlights)
  oEllipse(sx,headCY,hw,hh,sk);

  // ============ HAIR (RETRO ARCADE - SIMPLIFIED) ============
  const hC=lk.hairC;

  if(p.stats.hair==='bald'){
    // JORDAN — simple bald (no shine)
  }else if(p.stats.hair==='short'){
    // Short hair cap (simple, with outline!)
    ctx.fillStyle='#000';
    ctx.beginPath();
    ctx.ellipse(sx,headCY-hh*0.15,hw+OL+1,hh*0.7+OL+1,0,Math.PI,Math.PI*2);ctx.fill();
    ctx.fillStyle=hC;
    ctx.beginPath();
    ctx.ellipse(sx,headCY-hh*0.15,hw+1,hh*0.7,0,Math.PI,Math.PI*2);ctx.fill();
  }else if(p.stats.hair==='headband'){
    // Hair above headband
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(sx,headCY-hh*0.25,hw+OL+1,hh*0.65+OL,0,Math.PI,Math.PI*2);ctx.fill();
    ctx.fillStyle=hC;
    ctx.beginPath();ctx.ellipse(sx,headCY-hh*0.25,hw+1,hh*0.65,0,Math.PI,Math.PI*2);ctx.fill();

    // BUTLER — simplified spiky hair
    if(pid==='butler'){
      ctx.fillStyle=hC;ctx.strokeStyle='#000';ctx.lineWidth=2;
      for(let i=-4;i<=4;i++){
        const bx=sx+i*5;const ang=-0.9+i*0.2;const len=22+Math.abs(i)*4;
        ctx.save();ctx.translate(bx,headCY-hh-1);ctx.rotate(ang);
        ctx.fillRect(-3,0,6,-len);
        ctx.strokeRect(-3,0,6,-len);
        ctx.restore();
      }
    }

    // LEBRON — simple receding hairline
    if(pid==='lebron'){
      ctx.fillStyle=sk;
      ctx.beginPath();ctx.ellipse(sx,headCY-hh+4,hw*0.55,hh*0.22,0,0,Math.PI*2);ctx.fill();
    }

    // GIANNIS — tufts above headband
    if(pid==='giannis'){
      ctx.fillStyle=hC;
      for(let i=-2;i<=2;i++){
        ctx.beginPath();ctx.ellipse(sx+i*6,headCY-hh-2,5,4,0,0,Math.PI*2);ctx.fill();
      }
    }

    // HEADBAND (bold, with outline!)
    const hbY=headCY-hh*0.6;
    ctx.fillStyle='#000';
    ctx.fillRect(sx-hw-4,hbY-1,hw*2+8,9);
    ctx.fillStyle=c1;
    ctx.fillRect(sx-hw-2,hbY+1,hw*2+4,6);
  }else if(p.stats.hair==='ponytail'){
    // Full hair top (outlined)
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(sx,headCY-hh*0.2,hw+OL+2,hh*0.68+OL+1,0,Math.PI,Math.PI*2);ctx.fill();
    ctx.fillStyle=hC;
    ctx.beginPath();ctx.ellipse(sx,headCY-hh*0.2,hw+2,hh*0.68,0,Math.PI,Math.PI*2);ctx.fill();

    // Ponytail flowing behind (thick, with outline!)
    ctx.strokeStyle='#000';ctx.lineWidth=10;ctx.lineCap='round';
    ctx.beginPath();
    ctx.moveTo(sx-fDir*3,headCY-hh*0.8);
    ctx.quadraticCurveTo(sx-fDir*30,headCY-hh-5,sx-fDir*38,headCY);
    ctx.quadraticCurveTo(sx-fDir*42,headCY+15,sx-fDir*32,headCY+22);
    ctx.stroke();
    ctx.strokeStyle=hC;ctx.lineWidth=7;
    ctx.beginPath();
    ctx.moveTo(sx-fDir*3,headCY-hh*0.8);
    ctx.quadraticCurveTo(sx-fDir*30,headCY-hh-5,sx-fDir*38,headCY);
    ctx.quadraticCurveTo(sx-fDir*42,headCY+15,sx-fDir*32,headCY+22);
    ctx.stroke();
  }else if(p.stats.hair==='braids'){
    // Hair top
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(sx,headCY-hh*0.15,hw+OL+1,hh*0.65+OL,0,Math.PI,Math.PI*2);ctx.fill();
    ctx.fillStyle=hC;
    ctx.beginPath();ctx.ellipse(sx,headCY-hh*0.15,hw+1,hh*0.65,0,Math.PI,Math.PI*2);ctx.fill();

    // BRAIDS hanging down (thick, with outlines!)
    for(let b=-3;b<=3;b++){
      const bsx=sx+b*5.5, bsy=headCY+hh*0.3;
      ctx.strokeStyle='#000';ctx.lineWidth=5;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(bsx,bsy);
      ctx.quadraticCurveTo(bsx+b*2,bsy+18,bsx+b*3,bsy+30);ctx.stroke();
      ctx.strokeStyle=hC;ctx.lineWidth=3;
      ctx.beginPath();ctx.moveTo(bsx,bsy);
      ctx.quadraticCurveTo(bsx+b*2,bsy+18,bsx+b*3,bsy+30);ctx.stroke();
    }
  }

  // ============ FACE (RETRO ARCADE SIMPLE) ============
  const eyeCX=sx+fDir*6;
  const eyeCY=headCY-hh*0.05;
  const es=lk.eyeSz;

  // EYES — simple white ovals with pupils (RETRO: no iris, no shine)
  oEllipse(eyeCX-8,eyeCY,8*es,6*es,'#FFF');
  oEllipse(eyeCX+8,eyeCY,8*es,6*es,'#FFF');

  // Pupils only
  ctx.fillStyle='#000';
  ctx.beginPath();ctx.arc(eyeCX-8+fDir*2.5,eyeCY+0.5,3*es,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(eyeCX+8+fDir*2.5,eyeCY+0.5,3*es,0,Math.PI*2);ctx.fill();

  // Angry eyes when dunking/shoving/blocking/shooting peak
  if(p.dunking||p.shoving||p.blocking||p.stealing||(aType==='JUMP_SHOT'&&(aPhase==='HANG'||aPhase==='RELEASE'))){
    ctx.strokeStyle='#000';ctx.lineWidth=3;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(eyeCX-8-6,eyeCY-8);ctx.lineTo(eyeCX-8+6,eyeCY-11);ctx.stroke();
    ctx.beginPath();ctx.moveTo(eyeCX+8-6,eyeCY-11);ctx.lineTo(eyeCX+8+6,eyeCY-8);ctx.stroke();
  }else{
    // Normal eyebrows (thicker for RETRO)
    ctx.strokeStyle=lk.hairC;ctx.lineWidth=4;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(eyeCX-8-5,eyeCY-8);ctx.lineTo(eyeCX-8+5,eyeCY-9);ctx.stroke();
    ctx.beginPath();ctx.moveTo(eyeCX+8-5,eyeCY-9);ctx.lineTo(eyeCX+8+5,eyeCY-8);ctx.stroke();
  }

  // NOSE (simple triangle, no nostrils)
  const nw=lk.noseW;
  ctx.fillStyle=skD;
  ctx.beginPath();
  ctx.moveTo(sx+fDir*4,eyeCY+5);
  ctx.lineTo(sx+fDir*4-4*nw,headCY+hh*0.25);
  ctx.lineTo(sx+fDir*4+4*nw,headCY+hh*0.25);
  ctx.closePath();ctx.fill();

  // MOUTH (simple: open black circle when active, line when neutral)
  const mY=headCY+hh*0.42;
  if(p.dunking||p.onFire||p.shoving||p.blocking||p.stealing||(aType==='JUMP_SHOT'&&aPhase==='HANG')){
    // SCREAMING — open mouth (black circle)
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(sx+fDir*4,mY,9,7,0,0,Math.PI*2);ctx.fill();
  }else if(!moving){
    // Simple mouth line when neutral
    ctx.strokeStyle=skD;ctx.lineWidth=2;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(sx+fDir*2-5,mY);ctx.lineTo(sx+fDir*2+5,mY-1);ctx.stroke();
  }

  // ============ FACIAL HAIR (simple!) ============
  if(lk.beard==='mustache'){
    // JORDAN thick mustache
    ctx.fillStyle=lk.beardC;
    ctx.beginPath();
    ctx.moveTo(sx+fDir*4-10,mY-3);
    ctx.quadraticCurveTo(sx+fDir*4,mY-8,sx+fDir*4+10,mY-3);
    ctx.quadraticCurveTo(sx+fDir*4,mY-1,sx+fDir*4-10,mY-3);
    ctx.fill();
    ctx.strokeStyle='#000';ctx.lineWidth=1.5;
    ctx.beginPath();
    ctx.moveTo(sx+fDir*4-10,mY-3);
    ctx.quadraticCurveTo(sx+fDir*4,mY-8,sx+fDir*4+10,mY-3);
    ctx.stroke();
  }else if(lk.beard==='goatee'){
    // Slim goatee
    ctx.fillStyle=lk.beardC;
    ctx.beginPath();ctx.ellipse(sx+fDir*3,mY+8,5,8,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#000';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.ellipse(sx+fDir*3,mY+8,5,8,0,0,Math.PI*2);ctx.stroke();
  }else if(lk.beard==='full'){
    // MASSIVE BEARD (LeBron/Butler) — simple solid fill
    ctx.fillStyle=lk.beardC;
    ctx.beginPath();
    ctx.moveTo(sx-hw*0.7,headCY+hh*0.15);
    ctx.quadraticCurveTo(sx-hw*0.75,headCY+hh*0.7,sx,headCY+hh*0.95);
    ctx.quadraticCurveTo(sx+hw*0.75,headCY+hh*0.7,sx+hw*0.7,headCY+hh*0.15);
    ctx.fill();
    // Beard outline
    ctx.strokeStyle='#000';ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(sx-hw*0.7,headCY+hh*0.15);
    ctx.quadraticCurveTo(sx-hw*0.75,headCY+hh*0.7,sx,headCY+hh*0.95);
    ctx.quadraticCurveTo(sx+hw*0.75,headCY+hh*0.7,sx+hw*0.7,headCY+hh*0.15);
    ctx.stroke();
  }

  // ============ CURRY MOUTHGUARD ============
  if(pid==='curry'){
    ctx.fillStyle='#00CCFF';
    ctx.strokeStyle='#000';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.ellipse(sx+fDir*6,mY+3,4,3,fDir*0.3,0,Math.PI*2);ctx.fill();ctx.stroke();
  }

  // ============ ON FIRE EFFECT (DRAMATIC AURA) ============
  if(p.onFire){
    const fl=Math.sin(titleTimer*0.3)*0.2+0.8;
    const fl2=Math.sin(titleTimer*0.5)*0.15+0.85;
    // Full body fire glow
    ctx.save();
    ctx.shadowColor='#FF4400';ctx.shadowBlur=35*fl;
    // Outer fire ring around entire player
    ctx.strokeStyle=`rgba(255,60,0,${0.35*fl})`;ctx.lineWidth=4;
    ctx.beginPath();ctx.ellipse(sx,sy-15,torsoW+8,45,0,0,Math.PI*2);ctx.stroke();
    // Head fire aura
    ctx.strokeStyle=`rgba(255,80,0,${0.7*fl})`;ctx.lineWidth=3;
    ctx.beginPath();ctx.ellipse(sx,headCY,hw+12,hh+12,0,0,Math.PI*2);ctx.stroke();
    ctx.strokeStyle=`rgba(255,200,0,${0.5*fl2})`;ctx.lineWidth=2;
    ctx.beginPath();ctx.ellipse(sx,headCY,hw+7,hh+7,0,0,Math.PI*2);ctx.stroke();
    // Inner white-hot glow
    ctx.strokeStyle=`rgba(255,255,180,${0.25*fl})`;ctx.lineWidth=1.5;
    ctx.beginPath();ctx.ellipse(sx,headCY,hw+4,hh+4,0,0,Math.PI*2);ctx.stroke();
    ctx.shadowBlur=0;
    ctx.restore();
  }

  // === PIXELATION BLIT-BACK ===
  ctx.restore();
  ctx=mainCtx; // RESTORE main context
  ctx.save();
  const savedSmoothing=ctx.imageSmoothingEnabled;
  ctx.imageSmoothingEnabled=false;
  ctx.drawImage(pixCanvas, sx-sprW/2, sy-sprH*0.65, sprW, sprH);
  ctx.imageSmoothingEnabled=savedSmoothing;
  ctx.restore();

  // ============ PLAYER INDICATOR (on main canvas) ============
  if(p.controlled&&p.isP1){
    const arrowY=headCY-hh-20;
    const bob=Math.sin(titleTimer*0.12)*3;
    ctx.fillStyle='#00FF44';
    ctx.strokeStyle='#000';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(sx,arrowY+bob+8);ctx.lineTo(sx-8,arrowY+bob);ctx.lineTo(sx+8,arrowY+bob);ctx.closePath();
    ctx.fill();ctx.stroke();
    ctx.strokeStyle='rgba(0,255,68,0.35)';ctx.lineWidth=2;
    ctx.beginPath();ctx.ellipse(p.x,p.y+18,20,7,0,0,Math.PI*2);ctx.stroke();
  }

  // ============ NAME TAG (on main canvas) ============
  ctx.font='bold 10px Arial';ctx.textAlign='center';
  ctx.strokeStyle='#000';ctx.lineWidth=4;ctx.strokeText(p.stats.name,sx,p.y+36);
  ctx.fillStyle='#FFF';ctx.fillText(p.stats.name,sx,p.y+36);

  ctx.globalAlpha=1;
  ctx.restore();
}

function roundRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

// --- Ball on player ---
function drawBallOnPlayer(p){
  if(!p.hasBall)return;
  const a=p.anim;
  let bx=p.x+p.facing*18;
  let by=p.y-p.z;
  if(a&&a.type==='DUNK'){
    // Ball rises with arms through phases
    const ph=a.phase;
    if(ph==='CROUCH'){by-=8;bx=p.x}
    else if(ph==='RISE'){by-=28;bx=p.x}
    else if(ph==='HANG'){by-=42;bx=p.x+Math.sin(a.fip*0.5)*2}
    else if(ph==='SLAM'){by-=lerp(42,10,Math.min(a.fip/10,1));bx=p.x}
    else{by-=38}
  }else if(a&&a.type==='JUMP_SHOT'){
    const ph=a.phase;
    if(ph==='GATHER'){by-=10;bx=p.x+p.facing*6}
    else if(ph==='RISE'){by-=22;bx=p.x+p.facing*10}
    else if(ph==='HANG'){by-=30;bx=p.x+p.facing*12}
    else{by-=20}
  }else if(p.dunking){by-=38}
  drawBasketball(bx,by,7);
}

function drawBasketball(x,y,r){
  ctx.fillStyle='#FF8C00';ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#CC6600';ctx.lineWidth=1;ctx.stroke();
  ctx.beginPath();ctx.moveTo(x-r,y);ctx.lineTo(x+r,y);ctx.stroke();
  ctx.beginPath();ctx.moveTo(x,y-r);ctx.lineTo(x,y+r);ctx.stroke();
}

function drawBall(){
  if(ball.owner)return;
  const pp=perspProject(ball.x,ball.y);
  const sc=pp.scale;
  ctx.fillStyle='rgba(0,0,0,0.25)';ctx.beginPath();ctx.ellipse(pp.x,pp.y+3*sc,7*sc,3*sc,0,0,Math.PI*2);ctx.fill();
  drawBasketball(pp.x,pp.y-ball.z*sc,8*sc);
}

function drawParticles(){
  for(const pt of particles){
    const pp=perspProject(pt.x,pt.y);
    const sc=pp.scale;
    const lifeRatio=pt.life/pt.maxLife;
    ctx.globalAlpha=lifeRatio;
    const sz=pt.size*sc;
    if(pt.star){
      // Comic-book star burst impact effect
      const px=pp.x,py=pp.y;
      const r=sz*sc*lifeRatio;
      ctx.save();
      ctx.fillStyle=pt.color;
      ctx.strokeStyle='#FFF';ctx.lineWidth=2;
      ctx.beginPath();
      for(let i=0;i<10;i++){
        const ang=i*Math.PI/5-Math.PI/2;
        const rad=i%2===0?r:r*0.4;
        if(i===0)ctx.moveTo(px+Math.cos(ang)*rad,py+Math.sin(ang)*rad);
        else ctx.lineTo(px+Math.cos(ang)*rad,py+Math.sin(ang)*rad);
      }
      ctx.closePath();ctx.fill();ctx.stroke();
      ctx.restore();
    }else if(pt.confetti){
      // Confetti — spinning rectangles
      ctx.save();
      ctx.translate(pp.x,pp.y);
      ctx.rotate(pt.life*0.3+pt.x*0.1);
      ctx.fillStyle=pt.color;
      ctx.fillRect(-sz*0.6,-sz*0.25,sz*1.2,sz*0.5);
      ctx.restore();
    }else if(pt.flame){
      // Flame-shaped bezier particle with gradient
      const px=pp.x,py=pp.y;
      const h=sz*1.8*lifeRatio;
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(px,py+sz*0.3);
      ctx.bezierCurveTo(px-sz*0.6,py-h*0.3,px-sz*0.3,py-h*0.7,px,py-h);
      ctx.bezierCurveTo(px+sz*0.3,py-h*0.7,px+sz*0.6,py-h*0.3,px,py+sz*0.3);
      ctx.closePath();
      const fg=ctx.createLinearGradient(px,py+sz*0.3,px,py-h);
      fg.addColorStop(0,'rgba(255,80,0,0.9)');fg.addColorStop(0.4,'rgba(255,180,0,0.7)');fg.addColorStop(1,'rgba(255,255,100,0)');
      ctx.fillStyle=fg;ctx.fill();
      ctx.restore();
    }else{
      ctx.fillStyle=pt.color;
      ctx.fillRect(pp.x-sz/2,pp.y-sz/2,sz,sz);
    }
  }
  ctx.globalAlpha=1;
}

// --- Diorama Background with Parallax Crowd & Arena Spotlights ---
function drawBackground(){
  // Rich dark arena gradient background
  const arenaGrd=ctx.createLinearGradient(0,0,0,H);
  arenaGrd.addColorStop(0,'#06061A');arenaGrd.addColorStop(0.15,'#0C0C28');
  arenaGrd.addColorStop(0.4,'#121236');arenaGrd.addColorStop(1,'#08081E');
  ctx.fillStyle=arenaGrd;ctx.fillRect(0,0,W,H);

  // Arena spotlight beams from ceiling (conic beams)
  ctx.save();ctx.globalCompositeOperation='lighter';
  const beamPositions=[{x:W*0.2,w:80},{x:W*0.5,w:120},{x:W*0.8,w:80}];
  beamPositions.forEach(b=>{
    const bg=ctx.createLinearGradient(b.x,0,b.x,160);
    bg.addColorStop(0,'rgba(200,200,255,0.06)');bg.addColorStop(0.5,'rgba(180,180,240,0.03)');bg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=bg;
    ctx.beginPath();ctx.moveTo(b.x-15,0);ctx.lineTo(b.x-b.w,160);ctx.lineTo(b.x+b.w,160);ctx.lineTo(b.x+15,0);ctx.closePath();ctx.fill();
  });
  ctx.restore();

  // Arena rafters / structural beams at top
  const grd=ctx.createLinearGradient(0,0,0,80);
  grd.addColorStop(0,'#050514');grd.addColorStop(1,'rgba(20,20,42,0)');
  ctx.fillStyle=grd;ctx.fillRect(0,0,W,80);
  // Rafter lines
  ctx.strokeStyle='rgba(60,60,100,0.2)';ctx.lineWidth=2;
  for(let i=0;i<7;i++){ctx.beginPath();ctx.moveTo(80+i*130,0);ctx.lineTo(80+i*130-40,80);ctx.stroke();}

  // Championship banners with glow
  for(let i=0;i<5;i++){
    const bxx=150+i*140;
    ctx.save();ctx.shadowColor='rgba(255,215,0,0.3)';ctx.shadowBlur=8;
    ctx.fillStyle='rgba(255,215,0,0.18)';ctx.fillRect(bxx,6,40,30);
    ctx.restore();
    ctx.fillStyle='rgba(255,215,0,0.35)';ctx.font='bold 10px Arial';ctx.textAlign='center';
    ctx.fillText('★',bxx+20,27);
  }

  // Arena scoreboard (center, above crowd)
  ctx.save();
  ctx.fillStyle='rgba(20,20,40,0.8)';roundRect(W/2-55,40,110,24,4);ctx.fill();
  ctx.strokeStyle='rgba(100,100,180,0.4)';ctx.lineWidth=1;roundRect(W/2-55,40,110,24,4);ctx.stroke();
  ctx.fillStyle='rgba(255,60,60,0.6)';ctx.font='bold 8px Arial';ctx.textAlign='center';
  ctx.fillText('NBA JAM',W/2,56);
  ctx.restore();

  // Crowd tiers (back to front, smaller to larger for depth)
  // Tier 3 (far back - small, dim)
  for(let i=0;i<65;i++){
    const cx=8+i*14.8;const cy=78;
    const bounce=Math.sin(titleTimer*0.03+i*0.5)*1;
    const hue=(i*43+97)%360;
    ctx.fillStyle=`hsl(${hue},40%,28%)`;
    ctx.fillRect(cx-2,cy-2+bounce,5,6);
    ctx.fillStyle=`hsl(25,30%,${33+(i*17)%15}%)`;
    ctx.beginPath();ctx.arc(cx,cy-5+bounce,3,0,Math.PI*2);ctx.fill();
  }
  // Tier 2 (middle)
  for(let i=0;i<58;i++){
    const cx=6+i*16.6;const cy=98;
    const bounce=Math.sin(titleTimer*0.04+i*0.6+1)*1.5;
    const hue=(i*53+137)%360;
    ctx.fillStyle=`hsl(${hue},50%,36%)`;
    ctx.fillRect(cx-3,cy-2+bounce,6,8);
    ctx.fillStyle=`hsl(25,35%,${38+(i*19)%18}%)`;
    ctx.beginPath();ctx.arc(cx,cy-6+bounce,3.5,0,Math.PI*2);ctx.fill();
  }
  // Tier 1 (front row - bigger, brighter, animated, occasional phone flashes)
  for(let i=0;i<50;i++){
    const cx=15+i*19;const cy=120;
    const bounce=Math.sin(titleTimer*0.05+i*0.7+2)*2.5;
    const hue=(i*47+200)%360;
    ctx.fillStyle=`hsl(${hue},55%,45%)`;
    ctx.fillRect(cx-3,cy-3+bounce,8,10);
    ctx.fillStyle=`hsl(25,38%,${42+(i*17)%20}%)`;
    ctx.beginPath();ctx.arc(cx+1,cy-7+bounce,4.5,0,Math.PI*2);ctx.fill();
    // Random camera flashes
    if(Math.sin(titleTimer*0.02+i*2.7)>0.97){
      ctx.fillStyle='rgba(255,255,255,0.7)';
      ctx.beginPath();ctx.arc(cx+1,cy-4+bounce,2,0,Math.PI*2);ctx.fill();
    }
  }

  // Side crowd walls
  const courtProj=perspProject(COURT.x,COURT.y);
  const courtProjBot=perspProject(COURT.x,COURT.y+COURT.h);
  // Left wall with subtle gradient
  const leftGrd=ctx.createLinearGradient(0,courtProj.y,courtProj.x,courtProj.y);
  leftGrd.addColorStop(0,'#1A1A34');leftGrd.addColorStop(1,'#10102A');
  ctx.fillStyle=leftGrd;
  ctx.beginPath();ctx.moveTo(0,90);ctx.lineTo(courtProj.x-10,courtProj.y);
  ctx.lineTo(courtProjBot.x-10,courtProjBot.y);ctx.lineTo(0,H);ctx.closePath();ctx.fill();
  // Right wall
  const courtProjR=perspProject(COURT.x+COURT.w,COURT.y);
  const courtProjRBot=perspProject(COURT.x+COURT.w,COURT.y+COURT.h);
  const rightGrd=ctx.createLinearGradient(W,courtProjR.y,courtProjR.x,courtProjR.y);
  rightGrd.addColorStop(0,'#1A1A34');rightGrd.addColorStop(1,'#10102A');
  ctx.fillStyle=rightGrd;
  ctx.beginPath();ctx.moveTo(W,90);ctx.lineTo(courtProjR.x+10,courtProjR.y);
  ctx.lineTo(courtProjRBot.x+10,courtProjRBot.y);ctx.lineTo(W,H);ctx.closePath();ctx.fill();

  // Side crowd people (left)
  for(let row=0;row<10;row++){
    const t=row/9;
    const cx2=lerp(10,courtProj.x-25,t*0.6);
    const cy2=lerp(courtProj.y+10,courtProjBot.y-15,t);
    const sz=lerp(3,6,t);
    const bounce2=Math.sin(titleTimer*0.04+row*1.2)*1.5;
    const hue2=(row*67+100)%360;
    ctx.fillStyle=`hsl(${hue2},45%,35%)`;
    ctx.fillRect(cx2-sz*0.4,cy2-sz*0.3+bounce2,sz*0.8,sz);
    ctx.fillStyle=`hsl(25,35%,${38+(row*23)%15}%)`;
    ctx.beginPath();ctx.arc(cx2,cy2-sz*0.6+bounce2,sz*0.5,0,Math.PI*2);ctx.fill();
  }
  // Side crowd people (right)
  for(let row=0;row<10;row++){
    const t=row/9;
    const cx2=lerp(W-10,courtProjR.x+25,t*0.6);
    const cy2=lerp(courtProjR.y+10,courtProjRBot.y-15,t);
    const sz=lerp(3,6,t);
    const bounce2=Math.sin(titleTimer*0.04+row*1.3+3)*1.5;
    const hue2=(row*73+180)%360;
    ctx.fillStyle=`hsl(${hue2},45%,35%)`;
    ctx.fillRect(cx2-sz*0.4,cy2-sz*0.3+bounce2,sz*0.8,sz);
    ctx.fillStyle=`hsl(25,35%,${38+(row*29)%15}%)`;
    ctx.beginPath();ctx.arc(cx2,cy2-sz*0.6+bounce2,sz*0.5,0,Math.PI*2);ctx.fill();
  }

  // Arena overhead lights (warm glow pools)
  ctx.save();ctx.globalCompositeOperation='lighter';
  ctx.fillStyle='rgba(255,220,120,0.035)';
  ctx.beginPath();ctx.ellipse(W*0.3,110,120,50,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(W*0.7,110,120,50,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,240,180,0.04)';
  ctx.beginPath();ctx.ellipse(W/2,115,180,60,0,0,Math.PI*2);ctx.fill();
  ctx.restore();

  // Court-side floor below court
  const floorGrd=ctx.createLinearGradient(0,courtProjBot.y,0,H);
  floorGrd.addColorStop(0,'#222240');floorGrd.addColorStop(1,'#0A0A18');
  ctx.fillStyle=floorGrd;
  ctx.fillRect(0,courtProjBot.y,W,H-courtProjBot.y);
}

// --- HUD ---
function drawHUD(){
  // Scoreboard background with team-colored panels
  ctx.fillStyle='rgba(0,0,0,0.92)';
  ctx.fillRect(0,0,W,50);
  // Team-colored panel backgrounds
  const t1c=TEAMS[selectedTeamP1].color1,t2c=TEAMS[selectedTeamP2].color1;
  const p1Grd=ctx.createLinearGradient(0,0,200,0);
  p1Grd.addColorStop(0,t1c);p1Grd.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=p1Grd;ctx.globalAlpha=0.2;ctx.fillRect(0,0,200,50);ctx.globalAlpha=1;
  const p2Grd=ctx.createLinearGradient(W,0,W-200,0);
  p2Grd.addColorStop(0,t2c);p2Grd.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=p2Grd;ctx.globalAlpha=0.2;ctx.fillRect(W-200,0,200,50);ctx.globalAlpha=1;
  // Gradient accent line
  const grd=ctx.createLinearGradient(0,48,W,48);
  grd.addColorStop(0,t1c);grd.addColorStop(0.5,'#555');grd.addColorStop(1,t2c);
  ctx.fillStyle=grd;ctx.fillRect(0,48,W,3);

  // P1 side
  ctx.font='bold 18px "Arial Black"';ctx.textAlign='left';
  ctx.fillStyle=t1c;ctx.fillText(TEAMS[selectedTeamP1].abbr,15,32);
  ctx.fillStyle='#FFF';ctx.font='bold 30px "Arial Black"';
  ctx.save();ctx.shadowColor='rgba(255,255,255,0.3)';ctx.shadowBlur=6;
  ctx.fillText(scoreP1.toString(),90,36);ctx.restore();
  ctx.font='10px Arial';ctx.fillStyle='#AAA';ctx.fillText('P1',15,15);

  // P2 side
  ctx.font='bold 18px "Arial Black"';ctx.textAlign='right';
  ctx.fillStyle=t2c;ctx.fillText(TEAMS[selectedTeamP2].abbr,W-15,32);
  ctx.fillStyle='#FFF';ctx.font='bold 30px "Arial Black"';
  ctx.save();ctx.shadowColor='rgba(255,255,255,0.3)';ctx.shadowBlur=6;
  ctx.fillText(scoreP2.toString(),W-90,36);ctx.restore();
  ctx.font='10px Arial';ctx.fillStyle='#AAA';ctx.fillText('CPU',W-18,15);

  // Quarter / Time (centered)
  ctx.textAlign='center';ctx.font='bold 12px Arial';ctx.fillStyle='#FFD700';
  ctx.fillText(quarter<=4?`QTR ${quarter}`:`OT ${quarter-4}`,W/2,14);
  const secs=Math.ceil(quarterTime/60);
  const mins=Math.floor(secs/60),s=secs%60;
  ctx.font='bold 22px "Arial Black"';
  const lowTime=secs<=10;
  ctx.fillStyle=lowTime?'#FF4444':'#FFF';
  if(lowTime){ctx.save();ctx.shadowColor='#FF0000';ctx.shadowBlur=10+Math.sin(titleTimer*0.3)*5;}
  ctx.fillText(`${mins}:${s.toString().padStart(2,'0')}`,W/2,40);
  if(lowTime)ctx.restore();

  // Shot clock (with pulsing red warning)
  const shotSecs=Math.ceil(shotClockTimer/60);
  if(shotSecs<=10&&!possessionLocked){
    const shotLow=shotSecs<=5;
    ctx.font='bold 16px Arial';
    if(shotLow){ctx.save();ctx.shadowColor='#FF0000';ctx.shadowBlur=8+Math.sin(titleTimer*0.4)*4;ctx.fillStyle='#FF2222';}
    else ctx.fillStyle='#FFD700';
    ctx.fillText(shotSecs,W/2+65,40);
    if(shotLow)ctx.restore();
  }

  // Turbo meter (enhanced with glow)
  const cp=getControlledPlayer();
  if(cp){
    const tx=15,ty=H-28,tw=130,th=10;
    ctx.fillStyle='rgba(0,0,0,0.75)';roundRect(tx-2,ty-2,tw+4,th+4,3);ctx.fill();
    ctx.strokeStyle='rgba(0,136,255,0.3)';ctx.lineWidth=1;roundRect(tx-2,ty-2,tw+4,th+4,3);ctx.stroke();
    const turboGrd=ctx.createLinearGradient(tx,0,tx+tw,0);
    turboGrd.addColorStop(0,'#0088FF');turboGrd.addColorStop(1,'#00DDFF');
    ctx.fillStyle=cp.turbo>25?turboGrd:'#FF4444';
    roundRect(tx,ty,tw*(cp.turbo/100),th,2);ctx.fill();
    ctx.font='bold 9px Arial';ctx.fillStyle='#CCC';ctx.textAlign='left';
    ctx.fillText('TURBO [SHIFT]',tx,ty-3);
  }

  // Fire indicator (with animated glow)
  players.filter(p=>p.onFire).forEach(p=>{
    const fireX=p.isP1?190:W-190;
    const fireY=30;
    const fl=Math.sin(titleTimer*0.25)*0.3+0.7;
    ctx.save();ctx.shadowColor='#FF4400';ctx.shadowBlur=12*fl;
    ctx.font='bold 12px Arial';ctx.fillStyle=`rgba(255,68,0,${fl})`;ctx.textAlign='center';
    ctx.fillText(`🔥 ${p.stats.name} ON FIRE! 🔥`,fireX,fireY);
    ctx.restore();
  });

  // Announcer (with dramatic glow/shadow)
  if(announcerTimer>0){
    announcerTimer--;
    const alpha=announcerTimer<20?announcerTimer/20:1;
    const scale=announcerTimer>100?1+(110-announcerTimer)*0.02:1;
    ctx.save();ctx.globalAlpha=alpha;
    ctx.translate(W/2,H/2-50);ctx.scale(scale,scale);
    ctx.font='bold 52px "Arial Black"';ctx.textAlign='center';
    // Dramatic glow behind text
    ctx.shadowColor='#FF8800';ctx.shadowBlur=20;
    ctx.strokeStyle='#000';ctx.lineWidth=8;ctx.strokeText(announcerText,0,0);
    ctx.shadowBlur=0;
    ctx.fillStyle='#FFD700';ctx.fillText(announcerText,0,0);
    // Hot inner glow
    ctx.fillStyle='rgba(255,255,200,0.3)';ctx.fillText(announcerText,0,-1);
    ctx.restore();ctx.globalAlpha=1;
  }

  // Possession lock indicator
  if(possessionLocked){
    ctx.font='bold 16px Arial';ctx.fillStyle='#FFF';ctx.textAlign='center';
    ctx.globalAlpha=0.6+Math.sin(titleTimer*0.1)*0.3;
    ctx.fillText('INBOUND',W/2,H/2+20);
    ctx.globalAlpha=1;
  }

  // Controls
  ctx.font='bold 13px Arial';ctx.fillStyle='rgba(255,255,255,0.55)';ctx.textAlign='center';
  ctx.fillText('WASD:Move  SHIFT:Turbo  SPACE:Shoot/Shove  X:Pass/Steal  Q:Switch  TAP\u00D72:Dunk',W/2,H-8);
}

// ============================================================
//  SCENES
// ============================================================
function updateTitle(){
  titleTimer++;
  if(keys['Enter']||keys['Space']){scene='teamselect';cursorTeam=0;keys['Enter']=false;keys['Space']=false;sfxSelect()}
}

function drawTitle(){
  ctx.fillStyle='#0A0A2E';ctx.fillRect(0,0,W,H);
  // Stars
  for(let i=0;i<60;i++){
    const x=(i*97+titleTimer*0.3)%W;
    const y=(i*53+Math.sin(i+titleTimer*0.02)*20)%H;
    ctx.fillStyle=`rgba(255,255,255,${0.3+Math.sin(titleTimer*0.05+i)*0.3})`;
    ctx.fillRect(x,y,2,2);
  }
  const bounce=Math.sin(titleTimer*0.06)*10;
  ctx.save();ctx.translate(W/2,190+bounce);
  // NBA
  ctx.font='bold 80px "Arial Black"';ctx.textAlign='center';
  ctx.strokeStyle='#000';ctx.lineWidth=8;ctx.strokeText('NBA',0,0);
  ctx.fillStyle='#FF4400';ctx.fillText('NBA',0,0);
  // JAM
  ctx.font='bold 130px "Arial Black"';
  ctx.strokeStyle='#000';ctx.lineWidth=10;ctx.strokeText('JAM',0,110);
  ctx.fillStyle='#FFD700';ctx.fillText('JAM',0,110);
  ctx.fillStyle='rgba(255,100,0,0.4)';ctx.fillText('JAM',3,113);
  ctx.restore();
  // Subtitle
  ctx.font='bold 18px Arial';ctx.fillStyle='#00CCFF';ctx.textAlign='center';
  ctx.fillText('T O U R N A M E N T   E D I T I O N',W/2,338+bounce);
  // Stars subtitle
  ctx.font='14px Arial';ctx.fillStyle='#FF8844';
  ctx.fillText('NBA + WNBA ALL-STARS',W/2,365+bounce);
  // Press start
  if(Math.floor(titleTimer/30)%2===0){
    ctx.font='bold 22px Arial';ctx.fillStyle='#FFF';
    ctx.fillText('PRESS ENTER OR SPACE TO START',W/2,450);
  }
  // Fire
  for(let i=0;i<6;i++){
    const fx=120+i*150,fy=H-55+Math.sin(titleTimer*0.1+i*2)*12;
    for(let j=0;j<5;j++){
      const t=(titleTimer*0.1+j*0.5)%1;ctx.globalAlpha=1-t;
      ctx.fillStyle=j<2?'#FF4400':j<4?'#FFD700':'#FFF';
      ctx.beginPath();ctx.arc(fx+Math.sin(t*6+j)*4,fy-t*25,8*(1-t)*0.6,0,Math.PI*2);ctx.fill();
    }
    ctx.globalAlpha=1;
  }
  ctx.font='11px Arial';ctx.fillStyle='rgba(255,255,255,0.25)';ctx.textAlign='center';
  ctx.fillText('A TRIBUTE TO MIDWAY ARCADE CLASSICS',W/2,H-18);
}

function updateTeamSelect(){
  selectTimer++;
  if(selectPhase===0){
    if(keys['ArrowLeft']||keys['KeyA']){cursorTeam=(cursorTeam-1+TEAMS.length)%TEAMS.length;keys['ArrowLeft']=false;keys['KeyA']=false;sfxSelect()}
    if(keys['ArrowRight']||keys['KeyD']){cursorTeam=(cursorTeam+1)%TEAMS.length;keys['ArrowRight']=false;keys['KeyD']=false;sfxSelect()}
    if(keys['ArrowUp']||keys['KeyW']){cursorTeam=(cursorTeam-4+TEAMS.length)%TEAMS.length;keys['ArrowUp']=false;keys['KeyW']=false;sfxSelect()}
    if(keys['ArrowDown']||keys['KeyS']){cursorTeam=(cursorTeam+4)%TEAMS.length;keys['ArrowDown']=false;keys['KeyS']=false;sfxSelect()}
    if(keys['Enter']||keys['Space']){
      selectedTeamP1=cursorTeam;
      do{selectedTeamP2=rndInt(0,TEAMS.length-1)}while(selectedTeamP2===selectedTeamP1);
      selectPhase=1;selectTimer=0;sfxSelect();keys['Enter']=false;keys['Space']=false;
    }
  }else if(selectPhase===1&&selectTimer>100){
    scene='gameplay';selectPhase=0;initGame();
  }
}

function drawTeamSelect(){
  ctx.fillStyle='#0A0A2E';ctx.fillRect(0,0,W,H);
  ctx.font='bold 34px "Arial Black"';ctx.fillStyle='#FFD700';ctx.textAlign='center';
  ctx.fillText('SELECT YOUR TEAM',W/2,55);

  const cols=4,rows=2,boxW=185,boxH=105,gap=18;
  const startX=(W-(cols*(boxW+gap)-gap))/2,startY=85;

  TEAMS.forEach((team,i)=>{
    const col=i%cols,row=Math.floor(i/cols);
    const bx=startX+col*(boxW+gap),by=startY+row*(boxH+gap);
    const sel=i===cursorTeam;

    ctx.fillStyle=sel?team.color1:'rgba(255,255,255,0.08)';
    roundRect(bx,by,boxW,boxH,5);ctx.fill();
    if(sel){
      ctx.strokeStyle='#FFD700';ctx.lineWidth=3;
      roundRect(bx-2,by-2,boxW+4,boxH+4,6);ctx.stroke();
      ctx.strokeStyle=`rgba(255,215,0,${0.3+Math.sin(selectTimer*0.1)*0.3})`;ctx.lineWidth=2;
      roundRect(bx-5,by-5,boxW+10,boxH+10,7);ctx.stroke();
    }
    ctx.fillStyle=team.color2;ctx.fillRect(bx+3,by,boxW-6,5);
    ctx.font='bold 17px "Arial Black"';ctx.fillStyle=sel?'#FFF':'rgba(255,255,255,0.5)';ctx.textAlign='center';
    ctx.fillText(team.name,bx+boxW/2,by+32);
    ctx.font='11px Arial';ctx.fillStyle=sel?'rgba(255,255,255,0.85)':'rgba(255,255,255,0.35)';
    ctx.fillText(team.players[0].name+' + '+team.players[1].name,bx+boxW/2,by+52);
    // NBA/WNBA tags
    ctx.font='bold 8px Arial';
    const tags=['NBA','WNBA'];
    team.players.forEach((pl,pi)=>{
      const isWNBA=['CLARK','PARKER','IONESCU','TAURASI','WILSON','OGWUMIKE','STEWART','PLUM'].some(n=>pl.name.includes(n));
      const tagX=bx+boxW/2+(pi===0?-40:40);
      ctx.fillStyle=isWNBA?'#FF69B4':'#00BBFF';
      ctx.fillText(isWNBA?'WNBA':'NBA',tagX,by+65);
    });

    if(selectPhase===1&&i===selectedTeamP1){
      ctx.fillStyle='rgba(0,255,0,0.2)';roundRect(bx,by,boxW,boxH,5);ctx.fill();
      ctx.font='bold 14px Arial';ctx.fillStyle='#0F0';ctx.fillText('P1',bx+boxW/2,by+boxH+16);
    }
    if(selectPhase===1&&i===selectedTeamP2){
      ctx.fillStyle='rgba(255,0,0,0.2)';roundRect(bx,by,boxW,boxH,5);ctx.fill();
      ctx.font='bold 14px Arial';ctx.fillStyle='#F44';ctx.fillText('CPU',bx+boxW/2,by+boxH+16);
    }
  });

  // Preview
  if(selectPhase===0){
    const team=TEAMS[cursorTeam],py=395;
    ctx.fillStyle='rgba(0,0,0,0.6)';roundRect(W/2-290,py,580,170,8);ctx.fill();
    for(let pi=0;pi<2;pi++){
      const px=W/2+(pi===0?-140:140);
      const plr=team.players[pi];
      ctx.font='bold 15px Arial';ctx.fillStyle=team.color1;ctx.textAlign='center';
      ctx.fillText(plr.name,px,py+22);
      const isWNBA=['CLARK','PARKER','IONESCU','TAURASI','WILSON','OGWUMIKE','STEWART','PLUM'].some(n=>plr.name.includes(n));
      ctx.font='bold 9px Arial';ctx.fillStyle=isWNBA?'#FF69B4':'#00BBFF';
      ctx.fillText(isWNBA?'WNBA':'NBA',px+60,py+22);

      [{name:'SPD',val:plr.spd},{name:'3PT',val:plr.threePt},{name:'DNK',val:plr.dunk},{name:'DEF',val:plr.def}].forEach((s,si)=>{
        const sx2=px-55,sy2=py+35+si*26;
        ctx.font='10px Arial';ctx.fillStyle='#AAA';ctx.textAlign='left';ctx.fillText(s.name,sx2,sy2+9);
        ctx.fillStyle='rgba(255,255,255,0.12)';ctx.fillRect(sx2+28,sy2,82,10);
        ctx.fillStyle=s.val>=8?'#0F0':s.val>=5?'#FFD700':'#F44';
        ctx.fillRect(sx2+28,sy2,82*(s.val/10),10);
      });
    }
  }
  ctx.font='13px Arial';ctx.fillStyle='rgba(255,255,255,0.45)';ctx.textAlign='center';
  ctx.fillText('ARROWS to browse  |  ENTER to select',W/2,H-22);
}

function updateHalftime(){
  halftimeTimer++;
  if(halftimeTimer>240||keys['Enter']||keys['Space']){
    scene='gameplay';quarter=3;quarterTime=QUARTER_LENGTH;shotClockTimer=SHOT_CLOCK;
    doInbound(scoreP1<=scoreP2);keys['Enter']=false;keys['Space']=false;
  }
}

function drawHalftime(){
  ctx.fillStyle='#0A0A2E';ctx.fillRect(0,0,W,H);
  ctx.font='bold 52px "Arial Black"';ctx.fillStyle='#FFD700';ctx.textAlign='center';ctx.fillText('HALFTIME',W/2,170);
  ctx.font='bold 28px "Arial Black"';ctx.fillStyle=TEAMS[selectedTeamP1].color1;ctx.fillText(TEAMS[selectedTeamP1].name,W/2-150,270);
  ctx.fillStyle='#FFF';ctx.font='bold 60px "Arial Black"';ctx.fillText(scoreP1,W/2-150,340);
  ctx.font='bold 28px "Arial Black"';ctx.fillStyle='#888';ctx.fillText('VS',W/2,290);
  ctx.fillStyle=TEAMS[selectedTeamP2].color1;ctx.fillText(TEAMS[selectedTeamP2].name,W/2+150,270);
  ctx.fillStyle='#FFF';ctx.font='bold 60px "Arial Black"';ctx.fillText(scoreP2,W/2+150,340);
  if(Math.floor(halftimeTimer/30)%2===0){ctx.font='20px Arial';ctx.fillStyle='#FFF';ctx.fillText('PRESS ENTER TO CONTINUE',W/2,450)}
}

function updateGameover(){
  gameoverTimer++;
  if(gameoverTimer>180&&(keys['Enter']||keys['Space'])){scene='title';gameoverTimer=0;keys['Enter']=false;keys['Space']=false}
}

function drawGameover(){
  ctx.fillStyle='#0A0A2E';ctx.fillRect(0,0,W,H);
  ctx.font='bold 52px "Arial Black"';ctx.fillStyle='#FFD700';ctx.textAlign='center';ctx.fillText('GAME OVER',W/2,140);
  const won=scoreP1>scoreP2;
  const winner=won?TEAMS[selectedTeamP1]:TEAMS[selectedTeamP2];
  ctx.font='bold 34px "Arial Black"';ctx.fillStyle=winner.color1;ctx.fillText(`${winner.name} WINS!`,W/2,220);
  ctx.font='bold 72px "Arial Black"';ctx.fillStyle='#FFF';
  ctx.fillText(`${Math.max(scoreP1,scoreP2)} - ${Math.min(scoreP1,scoreP2)}`,W/2,330);
  ctx.font='bold 28px Arial';ctx.fillStyle=won?'#0F0':'#F44';
  ctx.fillText(won?'VICTORY!':'DEFEATED',W/2,400);
  if(gameoverTimer>180&&Math.floor(gameoverTimer/30)%2===0){ctx.font='20px Arial';ctx.fillStyle='#FFF';ctx.fillText('PRESS ENTER TO CONTINUE',W/2,500)}
}

// ============================================================
//  MAIN LOOP
// ============================================================
function update(){
  titleTimer++;
  switch(scene){
    case'title':updateTitle();break;
    case'teamselect':updateTeamSelect();break;
    case'gameplay':
      updatePlayers();updateBall();updateParticles();updateCamera();
      if(shakeTimer>0)shakeTimer--;
      // Quarter clock (only ticks when not in dead-ball)
      if(!ball.shotInFlight&&!possessionLocked)quarterTime--;
      // Shot clock
      if(!possessionLocked&&ball.owner){
        shotClockTimer--;
        if(shotClockTimer<=0){
          // Shot clock violation - turnover
          announce('SHOT CLOCK!',60);
          const toP1=!ball.owner.isP1;
          ball.owner.hasBall=false;ball.owner=null;
          ball.loose=true;ball.vx=0;ball.vy=0;ball.vz=3;
          lockPossessionAndInbound(toP1);
        }
      }
      if(quarterTime<=0){
        if(quarter===2){scene='halftime';halftimeTimer=0;sfxBuzzer();announce('HALFTIME!',120)}
        else if(quarter>=4){
          if(scoreP1===scoreP2){quarter++;quarterTime=30*60;shotClockTimer=SHOT_CLOCK;announce('OVERTIME!',120);sfxBuzzer()}
          else{scene='gameover';gameoverTimer=0;sfxBuzzer()}
        }else{
          quarter++;quarterTime=QUARTER_LENGTH;shotClockTimer=SHOT_CLOCK;sfxBuzzer();announce(`QUARTER ${quarter}`,90);
          doInbound(quarter%2===1);
        }
      }
      break;
    case'halftime':updateHalftime();break;
    case'gameover':updateGameover();break;
  }
}

function draw(){
  ctx.clearRect(0,0,W,H);
  switch(scene){
    case'title':drawTitle();break;
    case'teamselect':drawTeamSelect();break;
    case'gameplay':
      ctx.save();
      if(shakeTimer>0)ctx.translate(rnd(-shakeMag,shakeMag),rnd(-shakeMag,shakeMag));
      drawBackground();drawCourt();
      // Floor reflections (faded, flipped silhouettes beneath players)
      [...players].sort((a,b)=>a.y-b.y).forEach(p=>{
        ctx.save();
        const pp=perspProject(p.x,p.y);
        const sc=pp.scale;
        ctx.globalAlpha=0.08;
        ctx.translate(pp.x,pp.y+40*sc);ctx.scale(sc,-sc*0.5);ctx.translate(-p.x,-p.y);
        // Simplified reflection — just body colored blobs
        const c1r=p.team.color1;
        ctx.fillStyle=c1r;
        ctx.fillRect(p.x-11,p.y-p.z-10,22,26);// torso
        ctx.beginPath();ctx.ellipse(p.x,p.y-p.z-30,20,20,0,0,Math.PI*2);ctx.fill();// head
        ctx.globalAlpha=1;
        ctx.restore();
      });
      drawBall();
      [...players].sort((a,b)=>a.y-b.y).forEach(p=>{
        ctx.save();
        const pp=perspProject(p.x,p.y);
        const sc=pp.scale;
        ctx.translate(pp.x,pp.y);ctx.scale(sc,sc);ctx.translate(-p.x,-p.y);
        drawPlayerTrails(p);drawTurboLines(p);
        drawPlayer(p);drawBallOnPlayer(p);
        ctx.restore();
      });
      drawParticles();drawPassIndicator();drawShotMeters();
      ctx.restore();drawHUD();
      break;
    case'halftime':drawHalftime();break;
    case'gameover':drawGameover();break;
  }
}

// ============================================================
//  BULLET TIME — fast gameplay with dramatic slowdown on key moments
// ============================================================
const GAME_SPEED_NORMAL=2.5;     // 2.5x speed for fast arcade feel
const GAME_SPEED_SLOMOSHOT=0.45; // dramatic slowdown for shots/dunks
const GAME_SPEED_SLOMOSTEAL=0.65; // slightly faster slowdown for steals
let gameSpeed=GAME_SPEED_NORMAL;
let targetGameSpeed=GAME_SPEED_NORMAL;
let gameSpeedAccum=0;
let bulletTimeVignette=0; // visual darkening effect 0-1

function isBulletTimeMoment(){
  for(const p of players){
    if(!p.anim)continue;
    const t=p.anim.type;
    // Shots: slow during HANG and RELEASE
    if(t==='JUMP_SHOT'&&(p.anim.phase==='HANG'||p.anim.phase==='RELEASE'))
      return{speed:GAME_SPEED_SLOMOSHOT,label:'JUMP SHOT'};
    // Dunks: slow during HANG and SLAM (the dramatic part)
    if((t==='DUNK'||t==='DUNK_EXTENDED')&&(p.anim.phase==='HANG'||p.anim.phase==='SLAM'))
      return{speed:GAME_SPEED_SLOMOSHOT,label:'SLAM DUNK'};
    // Also slow during RISE for dunks (building anticipation)
    if((t==='DUNK'||t==='DUNK_EXTENDED')&&p.anim.phase==='RISE'&&p.anim.fip>5)
      return{speed:0.6,label:null};
    // Steals: slow during REACH and SWIPE
    if(t==='STEAL'&&(p.anim.phase==='REACH'||p.anim.phase==='SWIPE'))
      return{speed:GAME_SPEED_SLOMOSTEAL,label:'STEAL'};
    // Block contest: extra slow-mo when defender is contesting a shot
    if(t==='BLOCK'&&p.contestMeter.active)
      return{speed:GAME_SPEED_SLOMOSHOT*0.8,label:'CONTESTED!'};
  }
  return null;
}

function gameLoop(){
  // Determine target speed
  const btMoment=scene==='gameplay'?isBulletTimeMoment():null;
  targetGameSpeed=btMoment?btMoment.speed:GAME_SPEED_NORMAL;

  // Smooth speed transitions (snappy enter, smooth exit)
  if(gameSpeed>targetGameSpeed){
    gameSpeed=Math.max(targetGameSpeed,gameSpeed-0.15); // quick slowdown
  }else{
    gameSpeed=Math.min(targetGameSpeed,gameSpeed+0.04); // gradual speed-up
  }

  // Vignette effect intensity
  const targetVig=btMoment?0.35:0;
  bulletTimeVignette+=(targetVig-bulletTimeVignette)*0.12;

  // Accumulator-based sub-stepping
  gameSpeedAccum+=gameSpeed;
  while(gameSpeedAccum>=1){
    update();
    gameSpeedAccum-=1;
  }

  draw();

  // Draw bullet-time vignette overlay
  if(bulletTimeVignette>0.01&&scene==='gameplay'){
    ctx.save();
    const grad=ctx.createRadialGradient(W/2,H/2,W*0.25,W/2,H/2,W*0.7);
    grad.addColorStop(0,`rgba(0,0,0,0)`);
    grad.addColorStop(1,`rgba(0,0,20,${bulletTimeVignette})`);
    ctx.fillStyle=grad;
    ctx.fillRect(0,0,W,H);
    ctx.restore();
  }

  // CRT scanline overlay (RETRO arcade effect)
  ctx.fillStyle='rgba(0,0,0,0.06)';
  for(let y=0;y<H;y+=3){ctx.fillRect(0,y,W,1);}
  // Warm CRT tint
  ctx.fillStyle='rgba(255,200,140,0.02)';
  ctx.fillRect(0,0,W,H);

  requestAnimationFrame(gameLoop);
}
gameLoop();
</script>
</body>
</html>
